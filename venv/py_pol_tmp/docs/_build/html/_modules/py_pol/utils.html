

<!DOCTYPE html>
<html class="writer-html4" lang="English" >
<head>
  <meta charset="utf-8">
  
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  
  <title>py_pol.utils &mdash; Python polarization 1.0.1 documentation</title>
  

  
  <link rel="stylesheet" href="../../_static/css/theme.css" type="text/css" />
  <link rel="stylesheet" href="../../_static/pygments.css" type="text/css" />

  
  
  
  

  
  <!--[if lt IE 9]>
    <script src="../../_static/js/html5shiv.min.js"></script>
  <![endif]-->
  
    
      <script type="text/javascript" id="documentation_options" data-url_root="../../" src="../../_static/documentation_options.js"></script>
        <script type="text/javascript" src="../../_static/jquery.js"></script>
        <script type="text/javascript" src="../../_static/underscore.js"></script>
        <script type="text/javascript" src="../../_static/doctools.js"></script>
        <script type="text/javascript" src="../../_static/language_data.js"></script>
        <script crossorigin="anonymous" integrity="sha256-Ae2Vz/4ePdIu6ZyI/5ZGsYnb+m0JlOmKPjt6XZ9JJkA=" type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/require.js/2.3.4/require.min.js"></script>
        <script async="async" type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/latest.js?config=TeX-AMS-MML_HTMLorMML"></script>
        <script type="text/x-mathjax-config">MathJax.Hub.Config({"tex2jax": {"inlineMath": [["$", "$"], ["\\(", "\\)"]], "processEscapes": true, "ignoreClass": "document", "processClass": "math|output_area"}})</script>
    
    <script type="text/javascript" src="../../_static/js/theme.js"></script>

    
    <link rel="index" title="Index" href="../../genindex.html" />
    <link rel="search" title="Search" href="../../search.html" /> 
</head>

<body class="wy-body-for-nav">

   
  <div class="wy-grid-for-nav">
    
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >
          

          
            <a href="../../index.html" class="icon icon-home" alt="Documentation Home"> Python polarization
          

          
          </a>

          
            
            
              <div class="version">
                1.0.1
              </div>
            
          

          
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>

          
        </div>

        
        <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="main navigation">
          
            
            
              
            
            
              <p class="caption"><span class="caption-text">Contents:</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../readme.html">1. Python polarization</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../installation.html">2. Installation</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../usage.html">3. Usage</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../modules.html">4. py_pol</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../tutorials.html">Tutorials</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../examples.html">Examples</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../contributing.html">5. Contributing</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../authors.html">6. Credits</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../history.html">7. History</a></li>
</ul>

            
          
        </div>
        
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">

      
      <nav class="wy-nav-top" aria-label="top navigation">
        
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../../index.html">Python polarization</a>
        
      </nav>


      <div class="wy-nav-content">
        
        <div class="rst-content">
        
          















<div role="navigation" aria-label="breadcrumbs navigation">

  <ul class="wy-breadcrumbs">
    
      <li><a href="../../index.html" class="icon icon-home"></a> &raquo;</li>
        
          <li><a href="../index.html">Module code</a> &raquo;</li>
        
      <li>py_pol.utils</li>
    
    
      <li class="wy-breadcrumbs-aside">
        
      </li>
    
  </ul>

  
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
            
  <h1>Source code for py_pol.utils</h1><div class="highlight"><pre>
<span></span><span class="ch">#!/usr/bin/env python3</span>
<span class="c1"># -*- coding: utf-8 -*-</span>

<span class="c1"># ------------------------------------</span>
<span class="c1"># Authors:    Luis Miguel Sanchez Brea and Jesus del Hoyo</span>
<span class="c1"># Date:       2019/01/09 (version 1.0)</span>
<span class="c1"># License:    GPL</span>
<span class="c1"># ------------------------------------</span>
<span class="sd">&quot;&quot;&quot; Common functions to classes &quot;&quot;&quot;</span>

<span class="kn">import</span> <span class="nn">multiprocessing</span>
<span class="kn">import</span> <span class="nn">time</span>

<span class="kn">import</span> <span class="nn">matplotlib.pyplot</span> <span class="k">as</span> <span class="nn">plt</span>
<span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
<span class="kn">import</span> <span class="nn">scipy</span> <span class="k">as</span> <span class="nn">sp</span>
<span class="kn">from</span> <span class="nn">numpy</span> <span class="k">import</span> <span class="n">array</span><span class="p">,</span> <span class="n">cos</span><span class="p">,</span> <span class="n">matrix</span><span class="p">,</span> <span class="n">pi</span><span class="p">,</span> <span class="n">sin</span><span class="p">,</span> <span class="n">sqrt</span><span class="p">,</span> <span class="n">tan</span>
<span class="kn">from</span> <span class="nn">scipy.optimize</span> <span class="k">import</span> <span class="n">leastsq</span>

<span class="kn">from</span> <span class="nn">.</span> <span class="k">import</span> <span class="p">(</span><span class="n">degrees</span><span class="p">,</span> <span class="n">eps</span><span class="p">,</span> <span class="n">limAlpha</span><span class="p">,</span> <span class="n">limDelta</span><span class="p">,</span> <span class="n">limAz</span><span class="p">,</span> <span class="n">limEl</span><span class="p">,</span> <span class="n">limRet</span><span class="p">,</span>
               <span class="n">figsize_default</span><span class="p">,</span> <span class="n">number_types</span><span class="p">)</span>

<span class="n">tol_default</span> <span class="o">=</span> <span class="n">eps</span>
<span class="n">NoneType</span> <span class="o">=</span> <span class="nb">type</span><span class="p">(</span><span class="kc">None</span><span class="p">)</span>


<div class="viewcode-block" id="prepare_variables"><a class="viewcode-back" href="../../py_pol.html#py_pol.utils.prepare_variables">[docs]</a><span class="k">def</span> <span class="nf">prepare_variables</span><span class="p">(</span><span class="nb">vars</span><span class="p">,</span>
                      <span class="n">expand</span><span class="o">=</span><span class="p">[</span><span class="kc">False</span><span class="p">],</span>
                      <span class="n">length</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>
                      <span class="n">obj</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                      <span class="n">give_shape</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Function that forces all variables of creation methods to be arrays, checks if all variables are a number or arrays of the same size, and expands the required variables if neccessary. If an object is introduced, it also checks that the length of the variables corresponds to the required lengtth for the object.</span>

<span class="sd">    Parameters:</span>
<span class="sd">        vars (list): List of variables.</span>
<span class="sd">        expand (bool or list): List of bools indicating which variables must be expanded.</span>
<span class="sd">        length (int): If some variables must be expanded but all of them have length 1, this will be the length of the new variables.</span>
<span class="sd">        obj (Py_pol object): Optical element object.</span>

<span class="sd">    Returns:</span>
<span class="sd">        vars (list): List of prepared variables.</span>
<span class="sd">        obj (Py_pol object): Optical element object (only if an obj was given to the function).</span>
<span class="sd">        shape (tuple): Shape of the variable with higher dimensionality.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1"># Calculate number of dimensions and shapes</span>
    <span class="n">N</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="nb">vars</span><span class="p">)</span>
    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">expand</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span> <span class="ow">and</span> <span class="n">N</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
        <span class="n">expand</span> <span class="o">=</span> <span class="n">expand</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">ones</span><span class="p">(</span><span class="n">N</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">bool</span><span class="p">)</span>
    <span class="n">lengths</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">N</span><span class="p">)</span>
    <span class="n">ndims</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">N</span><span class="p">)</span>
    <span class="n">shapes</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">ind</span><span class="p">,</span> <span class="n">elem</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="nb">vars</span><span class="p">):</span>
        <span class="n">elem</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">elem</span><span class="p">)</span>
        <span class="n">shapes</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">elem</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span>
        <span class="n">ndims</span><span class="p">[</span><span class="n">ind</span><span class="p">]</span> <span class="o">=</span> <span class="n">elem</span><span class="o">.</span><span class="n">ndim</span>
        <span class="n">lengths</span><span class="p">[</span><span class="n">ind</span><span class="p">]</span> <span class="o">=</span> <span class="n">elem</span><span class="o">.</span><span class="n">size</span>
        <span class="nb">vars</span><span class="p">[</span><span class="n">ind</span><span class="p">]</span> <span class="o">=</span> <span class="n">elem</span><span class="o">.</span><span class="n">flatten</span><span class="p">()</span>

    <span class="c1"># Check if all the elements have size 1 or the same</span>
    <span class="n">lengths_long</span> <span class="o">=</span> <span class="n">lengths</span><span class="p">[</span><span class="n">lengths</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">]</span>
    <span class="k">if</span> <span class="n">lengths_long</span><span class="o">.</span><span class="n">size</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="nb">all</span><span class="p">(</span><span class="n">lengths_long</span> <span class="o">==</span> <span class="n">lengths_long</span><span class="p">[</span><span class="mi">0</span><span class="p">]):</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
                <span class="s1">&#39;All parameters must be numbers or have the same number of elements&#39;</span>
            <span class="p">)</span>
    <span class="c1"># Check if the length is good for the object</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="p">(</span><span class="n">obj</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">):</span>
        <span class="n">length2</span> <span class="o">=</span> <span class="n">obj</span><span class="o">.</span><span class="n">size</span>
        <span class="k">if</span> <span class="n">lengths_long</span><span class="o">.</span><span class="n">size</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="ow">and</span> <span class="n">length2</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="p">(</span><span class="n">length2</span> <span class="o">==</span> <span class="n">lengths_long</span><span class="p">[</span><span class="mi">0</span><span class="p">]):</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
                    <span class="s1">&#39;The size of the variables is not the same as the number of elements in </span><span class="si">{}</span><span class="s1">&#39;</span>
                    <span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">obj</span><span class="o">.</span><span class="n">name</span><span class="p">))</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">length</span> <span class="o">=</span> <span class="n">length2</span>
    <span class="c1"># Expand parameters if required</span>
    <span class="k">if</span> <span class="n">lengths_long</span><span class="o">.</span><span class="n">size</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
        <span class="n">length_vars</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">lengths_long</span><span class="o">.</span><span class="n">max</span><span class="p">())</span>
        <span class="k">if</span> <span class="n">length_vars</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
            <span class="n">length</span> <span class="o">=</span> <span class="n">length_vars</span>
    <span class="k">for</span> <span class="n">ind</span><span class="p">,</span> <span class="n">elem</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="nb">vars</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">expand</span><span class="p">[</span><span class="n">ind</span><span class="p">]</span> <span class="ow">and</span> <span class="n">lengths</span><span class="p">[</span><span class="n">ind</span><span class="p">]</span> <span class="o">==</span> <span class="mi">1</span> <span class="ow">and</span> <span class="n">length</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
            <span class="nb">vars</span><span class="p">[</span><span class="n">ind</span><span class="p">]</span> <span class="o">=</span> <span class="n">elem</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">ones</span><span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="n">length</span><span class="p">))</span>

    <span class="c1"># if only one var was inserted, take it out of the list</span>
    <span class="k">if</span> <span class="n">N</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
        <span class="nb">vars</span> <span class="o">=</span> <span class="nb">vars</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>

    <span class="c1"># Expand object.M if required</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="p">(</span><span class="n">obj</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">length2</span> <span class="o">==</span> <span class="mi">1</span> <span class="ow">and</span> <span class="n">length</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
            <span class="c1"># if obj._type == &#39;Jones_vector&#39;:</span>
            <span class="c1">#     new_M = np.array([</span>
            <span class="c1">#         obj.M[0, 0] * np.ones(length),</span>
            <span class="c1">#         obj.M[1, 0] * np.ones(length)</span>
            <span class="c1">#     ])</span>
            <span class="c1">#     obj.from_matrix(new_M)</span>
            <span class="c1"># elif obj._type is &#39;Jones_matrix&#39;:</span>
            <span class="c1">#     new_M = np.array([</span>
            <span class="c1">#         [</span>
            <span class="c1">#             obj.M[0, 0, 0] * np.ones(length),</span>
            <span class="c1">#             obj.M[0, 1, 0] * np.ones(length)</span>
            <span class="c1">#         ],</span>
            <span class="c1">#         [</span>
            <span class="c1">#             obj.M[1, 0, 0] * np.ones(length),</span>
            <span class="c1">#             obj.M[1, 1, 0] * np.ones(length)</span>
            <span class="c1">#         ],</span>
            <span class="c1">#     ])</span>
            <span class="c1">#     obj.from_matrix(new_M)</span>
            <span class="c1"># else:</span>
            <span class="c1">#     raise ValueError(&#39;Not implemented yet&#39;)</span>
            <span class="n">new_M</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">multiply</span><span class="o">.</span><span class="n">outer</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">squeeze</span><span class="p">(</span><span class="n">obj</span><span class="o">.</span><span class="n">M</span><span class="p">),</span> <span class="n">np</span><span class="o">.</span><span class="n">ones</span><span class="p">(</span><span class="n">length</span><span class="p">))</span>
            <span class="k">if</span> <span class="n">obj</span><span class="o">.</span><span class="n">_type</span> <span class="ow">in</span> <span class="p">(</span><span class="s1">&#39;Stikes&#39;</span><span class="p">,</span> <span class="s1">&#39;Mueller&#39;</span><span class="p">):</span>
                <span class="n">obj</span><span class="o">.</span><span class="n">from_matrix</span><span class="p">(</span><span class="n">new_M</span><span class="p">,</span> <span class="n">global_phase</span><span class="o">=</span><span class="n">obj</span><span class="o">.</span><span class="n">global_phase</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">obj</span><span class="o">.</span><span class="n">from_matrix</span><span class="p">(</span><span class="n">new_M</span><span class="p">)</span>
    <span class="c1"># Check the shape with highest dimensionality</span>
    <span class="k">if</span> <span class="n">give_shape</span><span class="p">:</span>
        <span class="n">ind</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">argmax</span><span class="p">(</span><span class="n">ndims</span><span class="p">)</span>
        <span class="n">shapes</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="n">select_shape</span><span class="p">(</span><span class="n">obj</span><span class="p">,</span> <span class="n">shape_var</span><span class="o">=</span><span class="n">shapes</span><span class="p">[</span><span class="n">ind</span><span class="p">])</span>
    <span class="c1"># Output</span>
    <span class="k">if</span> <span class="n">obj</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">give_shape</span><span class="p">:</span>
            <span class="k">return</span> <span class="nb">vars</span><span class="p">,</span> <span class="n">shapes</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="nb">vars</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">give_shape</span><span class="p">:</span>
            <span class="k">return</span> <span class="nb">vars</span><span class="p">,</span> <span class="n">obj</span><span class="p">,</span> <span class="n">shapes</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="nb">vars</span><span class="p">,</span> <span class="n">obj</span></div>


<div class="viewcode-block" id="expand_objects"><a class="viewcode-back" href="../../py_pol.html#py_pol.utils.expand_objects">[docs]</a><span class="k">def</span> <span class="nf">expand_objects</span><span class="p">(</span><span class="n">lista</span><span class="p">,</span> <span class="n">length</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">copy</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Expand a list of objects.</span>

<span class="sd">    Parameters:</span>
<span class="sd">        lista (list): List of py_pol objects.</span>
<span class="sd">        length (int): If some variables must be expanded but all of them have length 1, this will be the length of the new variables. Default: 1.</span>
<span class="sd">        copy (bool): If True, the object are copied. Default: False.</span>

<span class="sd">    Returns:</span>
<span class="sd">        new_list (list): List of expanded objects.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1"># Take the sizes and shapes</span>
    <span class="n">N</span> <span class="o">=</span> <span class="mi">1</span>
    <span class="n">shape</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="k">for</span> <span class="n">obj</span> <span class="ow">in</span> <span class="n">lista</span><span class="p">:</span>
        <span class="c1"># Update size</span>
        <span class="k">if</span> <span class="n">obj</span><span class="o">.</span><span class="n">size</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">N</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
                <span class="n">N</span> <span class="o">=</span> <span class="n">obj</span><span class="o">.</span><span class="n">size</span>
            <span class="k">elif</span> <span class="n">N</span> <span class="o">&gt;</span> <span class="mi">1</span> <span class="ow">and</span> <span class="n">N</span> <span class="o">!=</span> <span class="n">obj</span><span class="o">.</span><span class="n">size</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s1">&#39;Objects are of different size&#39;</span><span class="p">)</span>
        <span class="c1"># Update shape</span>
        <span class="k">if</span> <span class="n">shape</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">shape</span> <span class="o">=</span> <span class="n">obj</span><span class="o">.</span><span class="n">shape</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">obj</span><span class="o">.</span><span class="n">shape</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="nb">len</span><span class="p">(</span><span class="n">obj</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span> <span class="o">&gt;</span> <span class="nb">len</span><span class="p">(</span><span class="n">shape</span><span class="p">):</span>
                <span class="n">shape</span> <span class="o">=</span> <span class="n">obj</span><span class="o">.</span><span class="n">shape</span>
    <span class="k">if</span> <span class="n">N</span> <span class="o">==</span> <span class="mi">1</span> <span class="ow">and</span> <span class="n">length</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
        <span class="n">N</span> <span class="o">=</span> <span class="n">length</span>
        <span class="n">shape</span> <span class="o">=</span> <span class="p">[</span><span class="n">N</span><span class="p">]</span>

    <span class="c1"># Expand</span>
    <span class="k">if</span> <span class="n">N</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
        <span class="n">new_list</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">obj</span> <span class="ow">in</span> <span class="n">lista</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">copy</span><span class="p">:</span>
                <span class="n">new_obj</span> <span class="o">=</span> <span class="n">obj</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">new_obj</span> <span class="o">=</span> <span class="n">obj</span>
            <span class="k">if</span> <span class="n">new_obj</span><span class="o">.</span><span class="n">size</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">new_obj</span><span class="o">.</span><span class="n">_type</span> <span class="ow">is</span> <span class="s1">&#39;Jones_vector&#39;</span><span class="p">:</span>
                    <span class="n">new_M</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span>
                        <span class="n">new_obj</span><span class="o">.</span><span class="n">M</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">]</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">ones</span><span class="p">(</span><span class="n">N</span><span class="p">),</span>
                        <span class="n">new_obj</span><span class="o">.</span><span class="n">M</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">]</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">ones</span><span class="p">(</span><span class="n">N</span><span class="p">)</span>
                    <span class="p">])</span>
                    <span class="n">new_obj</span><span class="o">.</span><span class="n">from_matrix</span><span class="p">(</span><span class="n">new_M</span><span class="p">)</span>
                <span class="k">elif</span> <span class="n">new_obj</span><span class="o">.</span><span class="n">_type</span> <span class="ow">is</span> <span class="s1">&#39;Jones_matrix&#39;</span><span class="p">:</span>
                    <span class="n">new_M</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span>
                        <span class="p">[</span>
                            <span class="n">new_obj</span><span class="o">.</span><span class="n">M</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">]</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">ones</span><span class="p">(</span><span class="n">N</span><span class="p">),</span>
                            <span class="n">new_obj</span><span class="o">.</span><span class="n">M</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">]</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">ones</span><span class="p">(</span><span class="n">N</span><span class="p">)</span>
                        <span class="p">],</span>
                        <span class="p">[</span>
                            <span class="n">new_obj</span><span class="o">.</span><span class="n">M</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">]</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">ones</span><span class="p">(</span><span class="n">N</span><span class="p">),</span>
                            <span class="n">new_obj</span><span class="o">.</span><span class="n">M</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">]</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">ones</span><span class="p">(</span><span class="n">N</span><span class="p">)</span>
                        <span class="p">],</span>
                    <span class="p">])</span>
                    <span class="n">new_obj</span><span class="o">.</span><span class="n">from_matrix</span><span class="p">(</span><span class="n">new_M</span><span class="p">)</span>
            <span class="n">new_list</span> <span class="o">+=</span> <span class="p">[</span><span class="n">new_obj</span><span class="p">]</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">new_list</span> <span class="o">=</span> <span class="n">lista</span>
    <span class="k">return</span> <span class="n">new_list</span></div>


<div class="viewcode-block" id="reshape"><a class="viewcode-back" href="../../py_pol.html#py_pol.utils.reshape">[docs]</a><span class="k">def</span> <span class="nf">reshape</span><span class="p">(</span><span class="nb">vars</span><span class="p">,</span> <span class="n">shape_like</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">shape_fun</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">shape</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">obj</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Reshapes an array of parameters to have the desired shape.</span>

<span class="sd">    Parameters:</span>
<span class="sd">        vars (list): List of variables.</span>
<span class="sd">        shape_like (numpy.ndarray or py_pol object): Use the shape of this object to reshape the variables.</span>
<span class="sd">        shape_fun (tuple, list or string): User-defined shape. If it is a string (like &#39;array&#39;) no manipulation is performed.</span>
<span class="sd">        shape (tuple or list): Default shape.</span>
<span class="sd">        obj (py_pol object): Py_pol object to take the shape from. Its preference is less than shape_like.</span>

<span class="sd">    Returns:</span>
<span class="sd">        vars (list): Reshaped list of variables.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1"># Check how many variables we have</span>
    <span class="n">N</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="nb">vars</span><span class="p">)</span>
    <span class="c1"># Select the correct shape</span>
    <span class="n">shape</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="n">select_shape</span><span class="p">(</span><span class="n">shape_var</span><span class="o">=</span><span class="n">shape</span><span class="p">,</span>
                            <span class="n">shape_fun</span><span class="o">=</span><span class="n">shape_fun</span><span class="p">,</span>
                            <span class="n">shape_like</span><span class="o">=</span><span class="n">shape_like</span><span class="p">,</span>
                            <span class="n">obj</span><span class="o">=</span><span class="n">obj</span><span class="p">)</span>
    <span class="c1"># Act only if there is a shape</span>
    <span class="k">if</span> <span class="n">shape</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">for</span> <span class="n">ind</span><span class="p">,</span> <span class="n">elem</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="nb">vars</span><span class="p">):</span>
            <span class="c1"># Act only if the element is not a number</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">elem</span><span class="p">,</span> <span class="n">number_types</span><span class="p">):</span>
                <span class="nb">vars</span><span class="p">[</span><span class="n">ind</span><span class="p">]</span> <span class="o">=</span> <span class="n">elem</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="n">shape</span><span class="p">)</span>
    <span class="c1"># If only one variable was given, take it out of the list</span>
    <span class="k">if</span> <span class="n">N</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
        <span class="k">return</span> <span class="nb">vars</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">return</span> <span class="nb">vars</span></div>


<div class="viewcode-block" id="select_shape"><a class="viewcode-back" href="../../py_pol.html#py_pol.utils.select_shape">[docs]</a><span class="k">def</span> <span class="nf">select_shape</span><span class="p">(</span><span class="n">obj</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">shape_var</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">shape_fun</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">shape_like</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Selects which shape to save.</span>

<span class="sd">    Parameters:</span>
<span class="sd">        obj (py_pol object): Object to be applied the shape. It is given here to check if the new shape is correct.</span>
<span class="sd">        shape_var (tuple or list): Shape of variables.</span>
<span class="sd">        shape_fun (tuple or list): Shape introduced manually by the user.</span>
<span class="sd">        shape_like (numpy.ndarray or py_pol object): Object to take the shape from.</span>

<span class="sd">    Returns:</span>
<span class="sd">        shape (tuple or list): Selected shape.</span>
<span class="sd">        ndim (int): Number of dimensions.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1"># If the size of the object is 0 or 1, just use None</span>
    <span class="k">if</span> <span class="n">obj</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">obj</span><span class="o">.</span><span class="n">size</span> <span class="o">&lt;=</span> <span class="mi">1</span><span class="p">:</span>
        <span class="n">shape</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="n">ndim</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="c1"># Now, take the shape with highest priority that is valid</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="c1"># Extract the shape from shape_like object</span>
        <span class="k">if</span> <span class="n">shape_like</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">shape_like</span> <span class="o">=</span> <span class="n">shape_like</span><span class="o">.</span><span class="n">shape</span>
        <span class="c1"># If obj is None, we don&#39;t need to check if the sahpe is valid, just taje the one with higherst priority</span>
        <span class="k">if</span> <span class="n">obj</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">shape</span> <span class="o">=</span> <span class="kc">None</span>
            <span class="n">shapes</span> <span class="o">=</span> <span class="p">[</span><span class="n">shape_like</span><span class="p">,</span> <span class="n">shape_fun</span><span class="p">,</span> <span class="n">shape_var</span><span class="p">]</span>
            <span class="k">for</span> <span class="n">s</span> <span class="ow">in</span> <span class="n">shapes</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">s</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                    <span class="c1"># If shape is False, force a None shape</span>
                    <span class="k">if</span> <span class="n">s</span> <span class="ow">is</span> <span class="kc">False</span><span class="p">:</span>
                        <span class="n">shape</span> <span class="o">=</span> <span class="kc">None</span>
                        <span class="k">break</span>
                    <span class="k">elif</span> <span class="nb">len</span><span class="p">(</span><span class="n">s</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                        <span class="n">shape</span> <span class="o">=</span> <span class="n">s</span>
                        <span class="k">break</span>

        <span class="c1"># When we have an object, we have to check if the shape is correct</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">shape</span> <span class="o">=</span> <span class="p">[</span><span class="n">obj</span><span class="o">.</span><span class="n">size</span><span class="p">]</span>
            <span class="n">shapes</span> <span class="o">=</span> <span class="p">[</span><span class="n">shape_like</span><span class="p">,</span> <span class="n">shape_fun</span><span class="p">,</span> <span class="n">shape_var</span><span class="p">,</span> <span class="n">obj</span><span class="o">.</span><span class="n">shape</span><span class="p">]</span>
            <span class="k">for</span> <span class="n">s</span> <span class="ow">in</span> <span class="n">shapes</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">s</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                    <span class="c1"># If shape is False, force a None shape</span>
                    <span class="k">if</span> <span class="n">s</span> <span class="ow">is</span> <span class="kc">False</span><span class="p">:</span>
                        <span class="n">shape</span> <span class="o">=</span> <span class="kc">None</span>
                        <span class="k">break</span>
                    <span class="c1"># Check that the shape is correct</span>
                    <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">s</span><span class="p">,</span> <span class="nb">int</span><span class="p">):</span>
                        <span class="n">shape</span> <span class="o">=</span> <span class="p">[</span><span class="n">s</span><span class="p">]</span>
                    <span class="k">elif</span> <span class="nb">len</span><span class="p">(</span><span class="n">s</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="ow">and</span> <span class="n">np</span><span class="o">.</span><span class="n">prod</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">s</span><span class="p">))</span> <span class="o">==</span> <span class="n">obj</span><span class="o">.</span><span class="n">size</span><span class="p">:</span>
                        <span class="n">shape</span> <span class="o">=</span> <span class="n">s</span>
                        <span class="k">break</span>
        <span class="c1"># Make sure that the shape is a list</span>
        <span class="k">if</span> <span class="n">shape</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">shape</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">shape</span><span class="p">)</span>
        <span class="c1"># Calculate the dimension of the object</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">shape</span><span class="p">,</span> <span class="p">(</span><span class="nb">tuple</span><span class="p">,</span> <span class="nb">list</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">)):</span>
            <span class="n">ndim</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">shape</span><span class="p">)</span>
        <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">shape</span><span class="p">,</span> <span class="nb">int</span><span class="p">):</span>
            <span class="n">ndim</span> <span class="o">=</span> <span class="mi">1</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">ndim</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="k">return</span> <span class="n">shape</span><span class="p">,</span> <span class="n">ndim</span></div>


<div class="viewcode-block" id="multitake"><a class="viewcode-back" href="../../py_pol.html#py_pol.utils.multitake">[docs]</a><span class="k">def</span> <span class="nf">multitake</span><span class="p">(</span><span class="n">arr</span><span class="p">,</span> <span class="n">indices</span><span class="p">,</span> <span class="n">axes</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Function that implements the numpy.take function in multiple axes.</span>

<span class="sd">    Parameters:</span>
<span class="sd">        arr (numpy.ndarray): Original array.</span>
<span class="sd">        indices (tuple or list): List with the indices values. In this function, only one value per axis is allowed.</span>
<span class="sd">        axes (tuple or list): List of axes.</span>

<span class="sd">    Returns:</span>
<span class="sd">        arr (numpy.ndarray): Taken array.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1"># Make all numpy arrays</span>
    <span class="n">arr</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">arr</span><span class="p">)</span>
    <span class="n">indices</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">indices</span><span class="p">)</span>
    <span class="n">axes</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">axes</span><span class="p">)</span>
    <span class="c1"># Order for increasing Axis</span>
    <span class="n">indices</span> <span class="o">=</span> <span class="n">indices</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">argsort</span><span class="p">(</span><span class="n">axes</span><span class="p">)]</span>
    <span class="n">axes</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sort</span><span class="p">(</span><span class="n">axes</span><span class="p">)</span>
    <span class="c1"># Loop along axes</span>
    <span class="k">for</span> <span class="n">ind</span><span class="p">,</span> <span class="n">ax</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">axes</span><span class="p">):</span>
        <span class="c1"># Take in this axis</span>
        <span class="n">arr</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">take</span><span class="p">(</span><span class="n">arr</span><span class="p">,</span> <span class="n">indices</span><span class="p">[</span><span class="n">ind</span><span class="p">],</span> <span class="n">ax</span> <span class="o">-</span> <span class="n">ind</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">arr</span></div>


<div class="viewcode-block" id="merge_indices"><a class="viewcode-back" href="../../py_pol.html#py_pol.utils.merge_indices">[docs]</a><span class="k">def</span> <span class="nf">merge_indices</span><span class="p">(</span><span class="n">ind1</span><span class="p">,</span> <span class="n">ind2</span><span class="p">,</span> <span class="n">axis</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Merges two sets of indices with poritions given by axis.&quot;&quot;&quot;</span>
    <span class="c1"># Make all arrays</span>
    <span class="n">ind1</span><span class="p">,</span> <span class="n">ind2</span><span class="p">,</span> <span class="n">axis</span> <span class="o">=</span> <span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">ind1</span><span class="p">),</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">ind2</span><span class="p">),</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">axis</span><span class="p">))</span>
    <span class="c1"># print(ind1, ind2, axis)</span>
    <span class="c1"># Sort the indices</span>
    <span class="k">if</span> <span class="n">axis</span><span class="o">.</span><span class="n">size</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
        <span class="n">ind1</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">insert</span><span class="p">(</span><span class="n">ind1</span><span class="p">,</span> <span class="n">axis</span><span class="p">,</span> <span class="n">ind2</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">order</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">argsort</span><span class="p">(</span><span class="n">axis</span><span class="p">)</span>
        <span class="n">ind2</span> <span class="o">=</span> <span class="n">ind2</span><span class="p">[</span><span class="n">order</span><span class="p">]</span>
        <span class="n">axis</span> <span class="o">=</span> <span class="n">axis</span><span class="p">[</span><span class="n">order</span><span class="p">]</span>
        <span class="k">for</span> <span class="n">ind</span><span class="p">,</span> <span class="n">elem</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">ind2</span><span class="p">):</span>
            <span class="c1"># print(&#39;entrada&#39;, ind1, axis, ind, elem)</span>
            <span class="n">ind1</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">insert</span><span class="p">(</span><span class="n">ind1</span><span class="p">,</span> <span class="n">axis</span><span class="p">[</span><span class="n">ind</span><span class="p">],</span> <span class="n">elem</span><span class="p">)</span>
            <span class="c1"># axis = axis + 1</span>
    <span class="k">return</span> <span class="n">ind1</span></div>


<div class="viewcode-block" id="combine_indices"><a class="viewcode-back" href="../../py_pol.html#py_pol.utils.combine_indices">[docs]</a><span class="k">def</span> <span class="nf">combine_indices</span><span class="p">(</span><span class="n">list_ind</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Combines the information given by np.unravel_index.&quot;&quot;&quot;</span>
    <span class="n">N_elem</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">list_ind</span><span class="p">)</span>
    <span class="n">N_ind</span> <span class="o">=</span> <span class="n">list_ind</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">size</span>
    <span class="n">final</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">i1</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">N_ind</span><span class="p">):</span>
        <span class="n">aux</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">elem</span> <span class="ow">in</span> <span class="n">list_ind</span><span class="p">:</span>
            <span class="n">aux</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">elem</span><span class="p">[</span><span class="n">i1</span><span class="p">])</span>
        <span class="n">final</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">aux</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">final</span></div>


<div class="viewcode-block" id="PrintParam"><a class="viewcode-back" href="../../py_pol.html#py_pol.utils.PrintParam">[docs]</a><span class="k">def</span> <span class="nf">PrintParam</span><span class="p">(</span>
        <span class="n">param</span><span class="p">,</span>
        <span class="n">verbose</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
        <span class="n">draw</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
        <span class="n">statistics</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
        <span class="n">shape</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
        <span class="c1"># shape_like=None,</span>
        <span class="c1"># shape_obj=None,</span>
        <span class="n">title</span><span class="o">=</span><span class="s1">&#39;&#39;</span><span class="p">,</span>
        <span class="n">heading</span><span class="o">=</span><span class="s1">&#39;&#39;</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Function to print the information during the calculation of some parameters.</span>

<span class="sd">    Parameters:</span>
<span class="sd">        param (np.array, list or tuple): List of variables to be represented.</span>
<span class="sd">        verbose (bool): If True, print the numeric values. Default: True.</span>
<span class="sd">        draw (bool): If True, plot 1D and 2D parameters. Default: True.</span>
<span class="sd">        statistics (bool): If True, a basic statistical analysis will be performed. Default: True.</span>
<span class="sd">        shape (list or tuple): Shape of the elements.</span>
<span class="sd">        title (string or list): Title or list of titles (1-D and 2-D elements).</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1"># Print heading</span>
    <span class="nb">print</span><span class="p">(</span><span class="n">heading</span><span class="p">)</span>
    <span class="c1"># Calculate the length of the number of parameters</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">param</span><span class="p">,</span> <span class="nb">list</span><span class="p">)</span> <span class="ow">or</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">param</span><span class="p">,</span> <span class="nb">tuple</span><span class="p">):</span>
            <span class="n">l</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">param</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">l</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
                <span class="n">param</span> <span class="o">=</span> <span class="n">param</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
                <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">title</span><span class="p">,</span> <span class="nb">list</span><span class="p">)</span> <span class="ow">or</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">title</span><span class="p">,</span> <span class="nb">tuple</span><span class="p">):</span>
                    <span class="n">title</span> <span class="o">=</span> <span class="n">title</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">l</span> <span class="o">=</span> <span class="mi">1</span>
    <span class="k">except</span><span class="p">:</span>
        <span class="n">l</span> <span class="o">=</span> <span class="mi">1</span>
    <span class="c1"># Calculate the dimension</span>
    <span class="c1"># if shape is not None:</span>
    <span class="c1">#     ndim = len(shape)</span>
    <span class="c1"># else:</span>
    <span class="c1">#     try:</span>
    <span class="c1">#         if l == 1:</span>
    <span class="c1">#             if param.size == 1:</span>
    <span class="c1">#                 ndim = 0</span>
    <span class="c1">#             else:</span>
    <span class="c1">#                 ndim = param.ndim</span>
    <span class="c1">#         else:</span>
    <span class="c1">#             if param[0].size == 1:</span>
    <span class="c1">#                 ndim = 0</span>
    <span class="c1">#             else:</span>
    <span class="c1">#                 ndim = param[0].ndim</span>
    <span class="c1">#     except:</span>
    <span class="c1">#         ndim = 0</span>
    <span class="c1"># print(ndim)</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">l</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">param</span><span class="o">.</span><span class="n">size</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
                <span class="n">ndim</span> <span class="o">=</span> <span class="mi">0</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">ndim</span> <span class="o">=</span> <span class="n">param</span><span class="o">.</span><span class="n">ndim</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">param</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">size</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
                <span class="n">ndim</span> <span class="o">=</span> <span class="mi">0</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">ndim</span> <span class="o">=</span> <span class="n">param</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">ndim</span>
    <span class="k">except</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">shape</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">ndim</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">shape</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">ndim</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="c1"># Check if there are complex or bool parameters</span>
    <span class="k">if</span> <span class="n">l</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
        <span class="n">is_complex</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">iscomplex</span><span class="p">(</span><span class="n">param</span><span class="p">)</span><span class="o">.</span><span class="n">any</span><span class="p">()</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">param</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">):</span>
            <span class="n">is_bool</span> <span class="o">=</span> <span class="n">param</span><span class="o">.</span><span class="n">dtype</span> <span class="ow">is</span> <span class="n">np</span><span class="o">.</span><span class="n">dtype</span><span class="p">(</span><span class="nb">bool</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">is_bool</span> <span class="o">=</span> <span class="kc">False</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">is_complex</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="n">is_bool</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">p</span> <span class="ow">in</span> <span class="n">param</span><span class="p">:</span>
            <span class="n">is_complex</span> <span class="o">=</span> <span class="n">is_complex</span> <span class="ow">or</span> <span class="n">np</span><span class="o">.</span><span class="n">iscomplex</span><span class="p">(</span><span class="n">p</span><span class="p">)</span><span class="o">.</span><span class="n">any</span><span class="p">()</span>
            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">):</span>
                <span class="n">is_bool</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">p</span><span class="o">.</span><span class="n">dtype</span> <span class="ow">is</span> <span class="n">np</span><span class="o">.</span><span class="n">dtype</span><span class="p">(</span><span class="nb">bool</span><span class="p">))</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">is_bool</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="kc">False</span><span class="p">)</span>

    <span class="c1"># Calculate desired size for figs</span>
    <span class="k">if</span> <span class="n">ndim</span> <span class="o">==</span> <span class="mi">1</span> <span class="ow">or</span> <span class="n">ndim</span> <span class="o">==</span> <span class="mi">2</span><span class="p">:</span>
        <span class="n">figsize</span> <span class="o">=</span> <span class="p">[</span><span class="mi">5</span><span class="p">,</span> <span class="mi">5</span><span class="p">]</span>
        <span class="k">if</span> <span class="n">is_complex</span><span class="p">:</span>
            <span class="n">figsize</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">l</span> <span class="o">*</span> <span class="n">figsize_default</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
            <span class="n">figsize</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="mi">2</span> <span class="o">*</span> <span class="n">figsize_default</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">f</span><span class="p">,</span> <span class="n">c</span> <span class="o">=</span> <span class="n">NumberOfSubplots</span><span class="p">(</span><span class="n">l</span><span class="p">)</span>
            <span class="n">figsize</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">f</span> <span class="o">*</span> <span class="n">figsize_default</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
            <span class="n">figsize</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">c</span> <span class="o">*</span> <span class="n">figsize_default</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>

    <span class="c1"># If verbose, print</span>
    <span class="k">if</span> <span class="n">verbose</span><span class="p">:</span>
        <span class="c1"># 0-D: just one element. Use letters only.</span>
        <span class="k">if</span> <span class="n">l</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="n">param</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">ind</span><span class="p">,</span> <span class="n">p</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">param</span><span class="p">):</span>
                <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;  &#39;</span> <span class="o">+</span> <span class="n">title</span><span class="p">[</span><span class="n">ind</span><span class="p">])</span>
                <span class="nb">print</span><span class="p">(</span><span class="n">p</span><span class="p">)</span>

    <span class="c1"># Draws</span>
    <span class="k">if</span> <span class="n">draw</span> <span class="ow">and</span> <span class="n">ndim</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Low dimensionality, figure not available.&#39;</span><span class="p">)</span>
    <span class="k">elif</span> <span class="n">draw</span> <span class="ow">and</span> <span class="n">ndim</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
        <span class="c1"># 1-D: row element. Use plot.</span>
        <span class="n">fig</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="n">figsize</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">l</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">is_complex</span><span class="p">:</span>
                <span class="n">plt</span><span class="o">.</span><span class="n">subplot</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
                <span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">real</span><span class="p">(</span><span class="n">param</span><span class="p">))</span>
                <span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="n">title</span> <span class="o">+</span> <span class="s1">&#39; (real)&#39;</span><span class="p">)</span>
                <span class="c1"># plt.colorbar()</span>
                <span class="n">plt</span><span class="o">.</span><span class="n">subplot</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">2</span><span class="p">)</span>
                <span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">imag</span><span class="p">(</span><span class="n">param</span><span class="p">))</span>
                <span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="n">title</span> <span class="o">+</span> <span class="s1">&#39; (imaginary)&#39;</span><span class="p">)</span>
                <span class="c1"># plt.colorbar()</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">param</span><span class="p">)</span>
                <span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="n">title</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="c1"># Check if there are complex parameters</span>
            <span class="k">for</span> <span class="n">ind</span><span class="p">,</span> <span class="n">p</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">param</span><span class="p">):</span>
                <span class="k">if</span> <span class="n">is_complex</span><span class="p">:</span>
                    <span class="n">plt</span><span class="o">.</span><span class="n">subplot</span><span class="p">(</span><span class="n">l</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">2</span> <span class="o">*</span> <span class="n">ind</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span>
                    <span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">real</span><span class="p">(</span><span class="n">p</span><span class="p">))</span>
                    <span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="n">title</span><span class="p">[</span><span class="n">ind</span><span class="p">]</span> <span class="o">+</span> <span class="s1">&#39; (real)&#39;</span><span class="p">)</span>
                    <span class="n">plt</span><span class="o">.</span><span class="n">subplot</span><span class="p">(</span><span class="n">l</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">2</span> <span class="o">*</span> <span class="n">ind</span> <span class="o">+</span> <span class="mi">2</span><span class="p">)</span>
                    <span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">imag</span><span class="p">(</span><span class="n">p</span><span class="p">))</span>
                    <span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="n">title</span><span class="p">[</span><span class="n">ind</span><span class="p">]</span> <span class="o">+</span> <span class="s1">&#39; (imaginary)&#39;</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">plt</span><span class="o">.</span><span class="n">subplot</span><span class="p">(</span><span class="n">f</span><span class="p">,</span> <span class="n">c</span><span class="p">,</span> <span class="n">ind</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span>
                    <span class="k">if</span> <span class="n">is_bool</span><span class="p">[</span><span class="n">ind</span><span class="p">]:</span>
                        <span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">p</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">int</span><span class="p">))</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">p</span><span class="p">)</span>
                    <span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="n">title</span><span class="p">[</span><span class="n">ind</span><span class="p">])</span>
        <span class="n">fig</span><span class="o">.</span><span class="n">canvas</span><span class="o">.</span><span class="n">draw_idle</span><span class="p">()</span>
    <span class="k">elif</span> <span class="n">draw</span> <span class="ow">and</span> <span class="n">ndim</span> <span class="o">==</span> <span class="mi">2</span><span class="p">:</span>
        <span class="c1"># 2-D: Use imshow</span>
        <span class="n">fig</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="n">figsize</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">l</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">is_complex</span><span class="p">:</span>
                <span class="n">plt</span><span class="o">.</span><span class="n">subplot</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
                <span class="n">plt</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">real</span><span class="p">(</span><span class="n">param</span><span class="p">))</span>
                <span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="n">title</span> <span class="o">+</span> <span class="s1">&#39; (real)&#39;</span><span class="p">)</span>
                <span class="n">plt</span><span class="o">.</span><span class="n">colorbar</span><span class="p">()</span>
                <span class="n">plt</span><span class="o">.</span><span class="n">subplot</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">2</span><span class="p">)</span>
                <span class="n">plt</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">imag</span><span class="p">(</span><span class="n">param</span><span class="p">))</span>
                <span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="n">title</span> <span class="o">+</span> <span class="s1">&#39; (imaginary)&#39;</span><span class="p">)</span>
                <span class="n">plt</span><span class="o">.</span><span class="n">colorbar</span><span class="p">()</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">is_bool</span><span class="p">:</span>
                    <span class="n">param</span> <span class="o">=</span> <span class="n">param</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">float</span><span class="p">)</span>
                <span class="n">plt</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span><span class="n">param</span><span class="p">)</span>
                <span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="n">title</span><span class="p">)</span>
                <span class="n">plt</span><span class="o">.</span><span class="n">colorbar</span><span class="p">()</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">ind</span><span class="p">,</span> <span class="n">p</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">param</span><span class="p">):</span>
                <span class="k">if</span> <span class="n">is_complex</span><span class="p">:</span>
                    <span class="n">plt</span><span class="o">.</span><span class="n">subplot</span><span class="p">(</span><span class="n">l</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">2</span> <span class="o">*</span> <span class="n">ind</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span>
                    <span class="n">plt</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">real</span><span class="p">(</span><span class="n">p</span><span class="p">))</span>
                    <span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="n">title</span><span class="p">[</span><span class="n">ind</span><span class="p">]</span> <span class="o">+</span> <span class="s1">&#39; (real)&#39;</span><span class="p">)</span>
                    <span class="n">plt</span><span class="o">.</span><span class="n">colorbar</span><span class="p">()</span>
                    <span class="n">plt</span><span class="o">.</span><span class="n">subplot</span><span class="p">(</span><span class="n">l</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">2</span> <span class="o">*</span> <span class="n">ind</span> <span class="o">+</span> <span class="mi">2</span><span class="p">)</span>
                    <span class="n">plt</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">imag</span><span class="p">(</span><span class="n">p</span><span class="p">))</span>
                    <span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="n">title</span><span class="p">[</span><span class="n">ind</span><span class="p">]</span> <span class="o">+</span> <span class="s1">&#39; (imaginary)&#39;</span><span class="p">)</span>
                    <span class="n">plt</span><span class="o">.</span><span class="n">colorbar</span><span class="p">()</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">plt</span><span class="o">.</span><span class="n">subplot</span><span class="p">(</span><span class="n">f</span><span class="p">,</span> <span class="n">c</span><span class="p">,</span> <span class="n">ind</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span>
                    <span class="k">if</span> <span class="n">is_bool</span><span class="p">[</span><span class="n">ind</span><span class="p">]:</span>
                        <span class="n">p</span> <span class="o">=</span> <span class="n">p</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">float</span><span class="p">)</span>
                    <span class="n">plt</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span><span class="n">p</span><span class="p">)</span>
                    <span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="n">title</span><span class="p">[</span><span class="n">ind</span><span class="p">])</span>
                    <span class="n">plt</span><span class="o">.</span><span class="n">colorbar</span><span class="p">()</span>
        <span class="n">fig</span><span class="o">.</span><span class="n">canvas</span><span class="o">.</span><span class="n">draw_idle</span><span class="p">()</span>
    <span class="k">elif</span> <span class="n">draw</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;High dimensionality, figure not available.&#39;</span><span class="p">)</span>

    <span class="c1"># Statistics</span>
    <span class="k">if</span> <span class="n">statistics</span> <span class="ow">and</span> <span class="n">ndim</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">l</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
            <span class="n">mean</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">param</span><span class="p">)</span>
            <span class="n">std</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">std</span><span class="p">(</span><span class="n">param</span><span class="p">)</span>
            <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;The mean value is </span><span class="si">{}</span><span class="s1"> +- </span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">mean</span><span class="p">,</span> <span class="n">std</span><span class="p">))</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">ind</span><span class="p">,</span> <span class="n">p</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">param</span><span class="p">):</span>
                <span class="n">mean</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">p</span><span class="p">)</span>
                <span class="n">std</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">std</span><span class="p">(</span><span class="n">p</span><span class="p">)</span>
                <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;The mean value of param </span><span class="si">{}</span><span class="s1"> is </span><span class="si">{}</span><span class="s1"> +- </span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                    <span class="n">title</span><span class="p">[</span><span class="n">ind</span><span class="p">],</span> <span class="n">mean</span><span class="p">,</span> <span class="n">std</span><span class="p">))</span>
    <span class="c1"># End</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
    <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;&#39;</span><span class="p">)</span>
    <span class="k">return</span> <span class="kc">None</span></div>


<div class="viewcode-block" id="take_shape"><a class="viewcode-back" href="../../py_pol.html#py_pol.utils.take_shape">[docs]</a><span class="k">def</span> <span class="nf">take_shape</span><span class="p">(</span><span class="n">objs</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Calculates the shape with higher dimensionality.&quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">objs</span><span class="p">,</span> <span class="p">(</span><span class="nb">list</span><span class="p">,</span> <span class="nb">tuple</span><span class="p">)):</span>
        <span class="n">l</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="n">shape</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="k">for</span> <span class="n">obj</span> <span class="ow">in</span> <span class="n">objs</span><span class="p">:</span>
            <span class="c1"># Fifferenciate between lists of objects and shapes</span>
            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">obj</span><span class="p">,</span> <span class="p">(</span><span class="nb">list</span><span class="p">,</span> <span class="nb">tuple</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">,</span> <span class="n">NoneType</span><span class="p">)):</span>
                <span class="n">s</span> <span class="o">=</span> <span class="n">obj</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">s</span> <span class="o">=</span> <span class="n">obj</span><span class="o">.</span><span class="n">shape</span>
            <span class="k">if</span> <span class="n">s</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">s</span><span class="p">)</span> <span class="o">&gt;</span> <span class="n">l</span><span class="p">:</span>
                    <span class="n">l</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">s</span><span class="p">)</span>
                    <span class="n">shape</span> <span class="o">=</span> <span class="n">s</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">shape</span> <span class="o">=</span> <span class="n">objs</span><span class="o">.</span><span class="n">shape</span>
    <span class="k">return</span> <span class="n">shape</span></div>


<div class="viewcode-block" id="kron_axis"><a class="viewcode-back" href="../../py_pol.html#py_pol.utils.kron_axis">[docs]</a><span class="k">def</span> <span class="nf">kron_axis</span><span class="p">(</span><span class="n">a</span><span class="p">,</span> <span class="n">b</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Function that implements the kronecker product along a given axis.</span>

<span class="sd">    Parameters:</span>
<span class="sd">        a, b (numpy.ndarray): Arrays to perform the operation.</span>
<span class="sd">        axis (int): Axis to perform the operation. a and b sizes in the rest of dimensions must be the same. If None, default np.kron is used.</span>

<span class="sd">    Result:</span>
<span class="sd">        (numpy.ndarray): Result.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="n">axis</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">kron</span><span class="p">(</span><span class="n">a</span><span class="p">,</span> <span class="n">b</span><span class="p">)</span>
    <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">axis</span><span class="p">,</span> <span class="nb">int</span><span class="p">):</span>
        <span class="c1"># Check dimensions</span>
        <span class="n">shape1</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">a</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span>
        <span class="k">del</span> <span class="n">shape1</span><span class="p">[</span><span class="n">axis</span><span class="p">]</span>
        <span class="n">shape2</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">b</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span>
        <span class="k">del</span> <span class="n">shape2</span><span class="p">[</span><span class="n">axis</span><span class="p">]</span>
        <span class="k">if</span> <span class="n">shape1</span> <span class="o">!=</span> <span class="n">shape2</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
                <span class="s1">&#39;a and b are of incompatible shapes </span><span class="si">{}</span><span class="s1"> and </span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                    <span class="n">a</span><span class="o">.</span><span class="n">shape</span><span class="p">,</span> <span class="n">b</span><span class="o">.</span><span class="n">shape</span><span class="p">))</span>
        <span class="c1"># Expand dimensions and multiply</span>
        <span class="n">a</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">expand_dims</span><span class="p">(</span><span class="n">a</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="n">axis</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span>
        <span class="n">b</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">expand_dims</span><span class="p">(</span><span class="n">b</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="n">axis</span><span class="p">)</span>
        <span class="n">res</span> <span class="o">=</span> <span class="n">a</span> <span class="o">*</span> <span class="n">b</span>
        <span class="k">return</span> <span class="n">res</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s1">&#39;Axis is of type </span><span class="si">{}</span><span class="s1"> instead of int&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
            <span class="nb">type</span><span class="p">(</span><span class="n">axis</span><span class="p">)))</span></div>


<div class="viewcode-block" id="prepare_variables_blocks"><a class="viewcode-back" href="../../py_pol.html#py_pol.utils.prepare_variables_blocks">[docs]</a><span class="k">def</span> <span class="nf">prepare_variables_blocks</span><span class="p">(</span><span class="n">M00</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                             <span class="n">Dv</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                             <span class="n">Pv</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                             <span class="n">m</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                             <span class="n">extend</span><span class="o">=</span><span class="p">[</span><span class="kc">False</span><span class="p">,</span> <span class="kc">False</span><span class="p">,</span> <span class="kc">False</span><span class="p">,</span> <span class="kc">False</span><span class="p">],</span>
                             <span class="n">multiply_by_M00</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
                             <span class="n">length</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>
                             <span class="n">obj</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                             <span class="n">other_shape</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                             <span class="n">give_shape</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Function that forces Mueller matrix block variables to be arrays of the desired size, checks they are compatible between them, and expands the required variables. If an object is introduced, it also checks that the length of the variables corresponds to the required lengtth for the object.</span>

<span class="sd">    Parameters:</span>
<span class="sd">        M00 (numpy.ndarray or float): Mean transmission coefficient.</span>
<span class="sd">        Dv (numpy.ndarray): Diattenuation vector. At least one of its dimensions must be of size 3.</span>
<span class="sd">        Pv (numpy.ndarray): Polarizance vector. At least one of its dimensions must be of size 3.</span>
<span class="sd">        m (numpy.ndarray): Small matrix m. At least two of its dimensions must be of size 3.</span>
<span class="sd">        extend (tuple or list with 4 bools): For each value, stretch the corresponding variable to match max size. Default: [False] * 4.</span>
<span class="sd">        multiply_by_M00 (bool): If True, multiplies Dv, Pv and m by M00.</span>
<span class="sd">        length (int): If some variables must be expanded but all of them have length 1, this will be the length of the new variables.</span>
<span class="sd">        obj (Py_pol object): Optical element object.</span>
<span class="sd">        give_shape (bool): If True, the output includes the shape variable.</span>
<span class="sd">        other_shape (int, tuple or list): Other suggested shape given by prepare_variables function.</span>

<span class="sd">    Returns:</span>
<span class="sd">        M00 (numpy.ndarray or float): 1xN array.</span>
<span class="sd">        Dv (numpy.ndarray): 3xN array.</span>
<span class="sd">        Pv (numpy.ndarray): 3xN array.</span>
<span class="sd">        m (numpy.ndarray): 3x3xN array.</span>
<span class="sd">        obj (Py_pol object): Optical element object (only if an obj was given to the function).</span>
<span class="sd">        shape (tuple): Shape of the variable with higher dimensionality.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1"># Check which variables are None</span>
    <span class="n">is_None</span> <span class="o">=</span> <span class="p">[</span><span class="n">Dv</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">,</span> <span class="n">Pv</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">,</span> <span class="n">m</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">,</span> <span class="n">M00</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">]</span>
    <span class="c1"># Check that the variable sizes are correct</span>
    <span class="n">M00</span><span class="p">,</span> <span class="n">Dv</span><span class="p">,</span> <span class="n">Pv</span><span class="p">,</span> <span class="n">m</span> <span class="o">=</span> <span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">M00</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">float</span><span class="p">),</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">Dv</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">float</span><span class="p">),</span>
                      <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">Pv</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">float</span><span class="p">),</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">m</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">float</span><span class="p">))</span>
    <span class="n">sizes</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">Dv</span><span class="o">.</span><span class="n">size</span> <span class="o">/</span> <span class="mi">3</span><span class="p">,</span> <span class="n">Pv</span><span class="o">.</span><span class="n">size</span> <span class="o">/</span> <span class="mi">3</span><span class="p">,</span> <span class="n">m</span><span class="o">.</span><span class="n">size</span> <span class="o">/</span> <span class="mi">9</span><span class="p">,</span> <span class="n">M00</span><span class="o">.</span><span class="n">size</span><span class="p">])</span>
    <span class="n">sizes</span><span class="p">[</span><span class="n">is_None</span><span class="p">]</span> <span class="o">=</span> <span class="mi">1</span>
    <span class="n">max_size</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">sizes</span><span class="p">)</span>
    <span class="n">cond</span> <span class="o">=</span> <span class="p">(</span><span class="n">sizes</span> <span class="o">==</span> <span class="n">max_size</span><span class="p">)</span> <span class="o">+</span> <span class="p">(</span><span class="n">sizes</span> <span class="o">==</span> <span class="mi">1</span><span class="p">)</span>
    <span class="k">if</span> <span class="nb">any</span><span class="p">(</span><span class="o">~</span><span class="n">cond</span><span class="p">):</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
            <span class="s1">&#39;M00 (</span><span class="si">{}</span><span class="s1">), Pv (</span><span class="si">{}</span><span class="s1">), Dv (</span><span class="si">{}</span><span class="s1">) and m (</span><span class="si">{}</span><span class="s1">) have diferent number of elements&#39;</span>
            <span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">sizes</span><span class="p">[</span><span class="mi">3</span><span class="p">],</span> <span class="n">sizes</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">sizes</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span> <span class="n">sizes</span><span class="p">[</span><span class="mi">1</span><span class="p">]))</span>
    <span class="c1"># Reshape M00</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">is_None</span><span class="p">[</span><span class="mi">3</span><span class="p">]:</span>
        <span class="n">shape1</span> <span class="o">=</span> <span class="n">M00</span><span class="o">.</span><span class="n">shape</span>
        <span class="n">M00</span> <span class="o">=</span> <span class="n">M00</span><span class="o">.</span><span class="n">flatten</span><span class="p">()</span>
        <span class="c1"># Multiply variables if required</span>
        <span class="k">if</span> <span class="n">multiply_by_M00</span><span class="p">:</span>
            <span class="n">cte</span> <span class="o">=</span> <span class="n">M00</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">cte</span> <span class="o">=</span> <span class="mi">1</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">shape1</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="n">cte</span> <span class="o">=</span> <span class="mi">1</span>
    <span class="c1"># Reshape Dv</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">is_None</span><span class="p">[</span><span class="mi">0</span><span class="p">]:</span>
        <span class="k">if</span> <span class="n">Dv</span><span class="o">.</span><span class="n">ndim</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">Dv</span><span class="o">.</span><span class="n">size</span> <span class="o">%</span> <span class="mi">3</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                <span class="n">Dv</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="n">Dv</span><span class="p">,</span> <span class="p">(</span><span class="mi">3</span><span class="p">,</span> <span class="nb">int</span><span class="p">(</span><span class="n">Dv</span><span class="o">.</span><span class="n">size</span> <span class="o">/</span> <span class="mi">3</span><span class="p">)))</span>
                <span class="n">shape2</span> <span class="o">=</span> <span class="p">[</span><span class="n">Dv</span><span class="o">.</span><span class="n">size</span> <span class="o">/</span> <span class="mi">3</span><span class="p">]</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
                    <span class="s1">&#39;Dv must have a number of elements multiple of 3.&#39;</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">shape2</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">Dv</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span>
            <span class="k">if</span> <span class="p">(</span><span class="n">shape2</span> <span class="o">==</span> <span class="mi">3</span><span class="p">)</span><span class="o">.</span><span class="n">any</span><span class="p">:</span>
                <span class="c1"># Store the shape of the desired outputs</span>
                <span class="n">ind</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">argmin</span><span class="p">(</span><span class="o">~</span><span class="p">(</span><span class="n">shape2</span> <span class="o">==</span> <span class="mi">3</span><span class="p">))</span>
                <span class="c1"># Store info</span>
                <span class="n">Dv</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span>
                    <span class="n">cte</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">take</span><span class="p">(</span><span class="n">Dv</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="n">ind</span><span class="p">)</span><span class="o">.</span><span class="n">flatten</span><span class="p">(),</span>
                    <span class="n">cte</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">take</span><span class="p">(</span><span class="n">Dv</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="n">ind</span><span class="p">)</span><span class="o">.</span><span class="n">flatten</span><span class="p">(),</span>
                    <span class="n">cte</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">take</span><span class="p">(</span><span class="n">Dv</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="n">ind</span><span class="p">)</span><span class="o">.</span><span class="n">flatten</span><span class="p">(),</span>
                <span class="p">])</span>
                <span class="n">shape2</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">delete</span><span class="p">(</span><span class="n">shape2</span><span class="p">,</span> <span class="n">ind</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
                    <span class="s1">&#39;Dv must have one axis with exactly 3 elements&#39;</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">shape2</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="c1"># Reshape Pv</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">is_None</span><span class="p">[</span><span class="mi">1</span><span class="p">]:</span>
        <span class="k">if</span> <span class="n">Pv</span><span class="o">.</span><span class="n">ndim</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">Pv</span><span class="o">.</span><span class="n">size</span> <span class="o">%</span> <span class="mi">3</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                <span class="n">Pv</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="n">Pv</span><span class="p">,</span> <span class="p">(</span><span class="mi">3</span><span class="p">,</span> <span class="nb">int</span><span class="p">(</span><span class="n">Pv</span><span class="o">.</span><span class="n">size</span> <span class="o">/</span> <span class="mi">3</span><span class="p">)))</span>
                <span class="n">shape3</span> <span class="o">=</span> <span class="kc">None</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
                    <span class="s1">&#39;Pv must have a number of elements multiple of 3.&#39;</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">shape3</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">Pv</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span>
            <span class="k">if</span> <span class="p">(</span><span class="n">shape3</span> <span class="o">==</span> <span class="mi">3</span><span class="p">)</span><span class="o">.</span><span class="n">any</span><span class="p">:</span>
                <span class="c1"># Store the shape of the desired outputs</span>
                <span class="n">ind</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">argmin</span><span class="p">(</span><span class="o">~</span><span class="p">(</span><span class="n">shape3</span> <span class="o">==</span> <span class="mi">3</span><span class="p">))</span>
                <span class="c1"># Store info</span>
                <span class="n">Pv</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span>
                    <span class="n">cte</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">take</span><span class="p">(</span><span class="n">Pv</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="n">ind</span><span class="p">)</span><span class="o">.</span><span class="n">flatten</span><span class="p">(),</span>
                    <span class="n">cte</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">take</span><span class="p">(</span><span class="n">Pv</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="n">ind</span><span class="p">)</span><span class="o">.</span><span class="n">flatten</span><span class="p">(),</span>
                    <span class="n">cte</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">take</span><span class="p">(</span><span class="n">Pv</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="n">ind</span><span class="p">)</span><span class="o">.</span><span class="n">flatten</span><span class="p">(),</span>
                <span class="p">])</span>
                <span class="n">shape3</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">delete</span><span class="p">(</span><span class="n">shape3</span><span class="p">,</span> <span class="n">ind</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
                    <span class="s1">&#39;Pv must have one axis with exactly 3 elements&#39;</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">shape3</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="c1"># Reshape m</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">is_None</span><span class="p">[</span><span class="mi">2</span><span class="p">]:</span>
        <span class="k">if</span> <span class="n">m</span><span class="o">.</span><span class="n">ndim</span> <span class="o">==</span> <span class="mi">1</span> <span class="ow">or</span> <span class="n">m</span><span class="o">.</span><span class="n">ndim</span> <span class="o">==</span> <span class="mi">2</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">m</span><span class="o">.</span><span class="n">size</span> <span class="o">%</span> <span class="mi">9</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                <span class="n">m</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="n">m</span><span class="p">,</span> <span class="p">(</span><span class="mi">3</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="nb">int</span><span class="p">(</span><span class="n">m</span><span class="o">.</span><span class="n">size</span> <span class="o">/</span> <span class="mi">9</span><span class="p">)))</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
                    <span class="s1">&#39;m must have a number of elements multiple of 9.&#39;</span><span class="p">)</span>
            <span class="n">shape4</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">shape4</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">m</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span>
            <span class="n">N</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">shape4</span> <span class="o">==</span> <span class="mi">3</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">N</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
                <span class="c1"># Find the matrix indices and the final shape</span>
                <span class="n">ind1</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">argmin</span><span class="p">(</span><span class="o">~</span><span class="p">(</span><span class="n">shape4</span> <span class="o">==</span> <span class="mi">3</span><span class="p">))</span>
                <span class="n">shape4</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">delete</span><span class="p">(</span><span class="n">shape4</span><span class="p">,</span> <span class="n">ind1</span><span class="p">)</span>
                <span class="n">ind2</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">argmin</span><span class="p">(</span><span class="o">~</span><span class="p">(</span><span class="n">shape4</span> <span class="o">==</span> <span class="mi">3</span><span class="p">))</span>
                <span class="n">shape4</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">delete</span><span class="p">(</span><span class="n">shape4</span><span class="p">,</span> <span class="n">ind2</span><span class="p">)</span>
                <span class="n">ind2</span> <span class="o">=</span> <span class="n">ind2</span> <span class="o">+</span> <span class="mi">1</span>
                <span class="c1"># Calculate the components and construct the matrix from them</span>
                <span class="n">m</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span>
                    <span class="p">[[</span>
                        <span class="n">cte</span> <span class="o">*</span> <span class="n">multitake</span><span class="p">(</span><span class="n">m</span><span class="p">,</span> <span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">],</span> <span class="p">[</span><span class="n">ind1</span><span class="p">,</span> <span class="n">ind2</span><span class="p">])</span><span class="o">.</span><span class="n">flatten</span><span class="p">(),</span>
                        <span class="n">cte</span> <span class="o">*</span> <span class="n">multitake</span><span class="p">(</span><span class="n">m</span><span class="p">,</span> <span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">],</span> <span class="p">[</span><span class="n">ind1</span><span class="p">,</span> <span class="n">ind2</span><span class="p">])</span><span class="o">.</span><span class="n">flatten</span><span class="p">(),</span>
                        <span class="n">cte</span> <span class="o">*</span> <span class="n">multitake</span><span class="p">(</span><span class="n">m</span><span class="p">,</span> <span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">2</span><span class="p">],</span> <span class="p">[</span><span class="n">ind1</span><span class="p">,</span> <span class="n">ind2</span><span class="p">])</span><span class="o">.</span><span class="n">flatten</span><span class="p">()</span>
                    <span class="p">],</span>
                     <span class="p">[</span>
                         <span class="n">cte</span> <span class="o">*</span> <span class="n">multitake</span><span class="p">(</span><span class="n">m</span><span class="p">,</span> <span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">],</span> <span class="p">[</span><span class="n">ind1</span><span class="p">,</span> <span class="n">ind2</span><span class="p">])</span><span class="o">.</span><span class="n">flatten</span><span class="p">(),</span>
                         <span class="n">cte</span> <span class="o">*</span> <span class="n">multitake</span><span class="p">(</span><span class="n">m</span><span class="p">,</span> <span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">],</span> <span class="p">[</span><span class="n">ind1</span><span class="p">,</span> <span class="n">ind2</span><span class="p">])</span><span class="o">.</span><span class="n">flatten</span><span class="p">(),</span>
                         <span class="n">cte</span> <span class="o">*</span> <span class="n">multitake</span><span class="p">(</span><span class="n">m</span><span class="p">,</span> <span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">],</span> <span class="p">[</span><span class="n">ind1</span><span class="p">,</span> <span class="n">ind2</span><span class="p">])</span><span class="o">.</span><span class="n">flatten</span><span class="p">()</span>
                     <span class="p">],</span>
                     <span class="p">[</span>
                         <span class="n">cte</span> <span class="o">*</span> <span class="n">multitake</span><span class="p">(</span><span class="n">m</span><span class="p">,</span> <span class="p">[</span><span class="mi">2</span><span class="p">,</span> <span class="mi">0</span><span class="p">],</span> <span class="p">[</span><span class="n">ind1</span><span class="p">,</span> <span class="n">ind2</span><span class="p">])</span><span class="o">.</span><span class="n">flatten</span><span class="p">(),</span>
                         <span class="n">cte</span> <span class="o">*</span> <span class="n">multitake</span><span class="p">(</span><span class="n">m</span><span class="p">,</span> <span class="p">[</span><span class="mi">2</span><span class="p">,</span> <span class="mi">1</span><span class="p">],</span> <span class="p">[</span><span class="n">ind1</span><span class="p">,</span> <span class="n">ind2</span><span class="p">])</span><span class="o">.</span><span class="n">flatten</span><span class="p">(),</span>
                         <span class="n">cte</span> <span class="o">*</span> <span class="n">multitake</span><span class="p">(</span><span class="n">m</span><span class="p">,</span> <span class="p">[</span><span class="mi">2</span><span class="p">,</span> <span class="mi">2</span><span class="p">],</span> <span class="p">[</span><span class="n">ind1</span><span class="p">,</span> <span class="n">ind2</span><span class="p">])</span><span class="o">.</span><span class="n">flatten</span><span class="p">()</span>
                     <span class="p">]])</span>

            <span class="k">else</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
                    <span class="s1">&#39;m must have 3 elements in at least 2 dimensions.&#39;</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">shape4</span> <span class="o">=</span> <span class="kc">None</span>

    <span class="c1"># Stretch object if required</span>
    <span class="k">if</span> <span class="n">obj</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">obj</span><span class="o">.</span><span class="n">size</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
        <span class="n">obj</span><span class="o">.</span><span class="n">M</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">multiply</span><span class="o">.</span><span class="n">outer</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">squeeze</span><span class="p">(</span><span class="n">obj</span><span class="o">.</span><span class="n">M</span><span class="p">),</span> <span class="n">np</span><span class="o">.</span><span class="n">ones</span><span class="p">(</span><span class="n">max_size</span><span class="p">))</span>
    <span class="c1"># Return</span>
    <span class="n">ret</span> <span class="o">=</span> <span class="p">[</span><span class="n">M00</span><span class="p">,</span> <span class="n">Dv</span><span class="p">,</span> <span class="n">Pv</span><span class="p">,</span> <span class="n">m</span><span class="p">]</span>
    <span class="k">if</span> <span class="n">obj</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">ret</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">obj</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">give_shape</span><span class="p">:</span>
        <span class="n">ret</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">take_shape</span><span class="p">([</span><span class="n">shape1</span><span class="p">,</span> <span class="n">shape2</span><span class="p">,</span> <span class="n">shape3</span><span class="p">,</span> <span class="n">shape4</span><span class="p">]))</span>
    <span class="k">return</span> <span class="n">ret</span></div>


<div class="viewcode-block" id="NumberOfSubplots"><a class="viewcode-back" href="../../py_pol.html#py_pol.utils.NumberOfSubplots">[docs]</a><span class="k">def</span> <span class="nf">NumberOfSubplots</span><span class="p">(</span><span class="n">n</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Auxiliar function to calculate the number of desired subplots.&quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="n">n</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
        <span class="n">f</span><span class="p">,</span> <span class="n">c</span> <span class="o">=</span> <span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
    <span class="k">elif</span> <span class="n">n</span> <span class="o">==</span> <span class="mi">2</span><span class="p">:</span>
        <span class="n">f</span><span class="p">,</span> <span class="n">c</span> <span class="o">=</span> <span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">)</span>
    <span class="k">elif</span> <span class="n">n</span> <span class="o">==</span> <span class="mi">3</span><span class="p">:</span>
        <span class="n">f</span><span class="p">,</span> <span class="n">c</span> <span class="o">=</span> <span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">3</span><span class="p">)</span>
    <span class="k">elif</span> <span class="n">n</span> <span class="o">==</span> <span class="mi">4</span><span class="p">:</span>
        <span class="n">f</span><span class="p">,</span> <span class="n">c</span> <span class="o">=</span> <span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="mi">2</span><span class="p">)</span>
    <span class="k">elif</span> <span class="n">n</span> <span class="o">==</span> <span class="mi">5</span> <span class="ow">or</span> <span class="n">n</span> <span class="o">==</span> <span class="mi">6</span><span class="p">:</span>
        <span class="n">f</span><span class="p">,</span> <span class="n">c</span> <span class="o">=</span> <span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="mi">3</span><span class="p">)</span>
    <span class="k">elif</span> <span class="n">n</span> <span class="o">==</span> <span class="mi">8</span><span class="p">:</span>
        <span class="n">f</span><span class="p">,</span> <span class="n">c</span> <span class="o">=</span> <span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="mi">4</span><span class="p">)</span>
    <span class="k">elif</span> <span class="n">n</span> <span class="o">&gt;</span> <span class="mi">6</span> <span class="ow">and</span> <span class="n">n</span> <span class="o">&lt;</span> <span class="mi">10</span><span class="p">:</span>
        <span class="n">f</span><span class="p">,</span> <span class="n">c</span> <span class="o">=</span> <span class="p">(</span><span class="mi">3</span><span class="p">,</span> <span class="mi">3</span><span class="p">)</span>
    <span class="k">elif</span> <span class="n">n</span> <span class="o">&gt;</span> <span class="mi">9</span> <span class="ow">and</span> <span class="n">n</span> <span class="o">&lt;</span> <span class="mi">17</span><span class="p">:</span>
        <span class="n">f</span><span class="p">,</span> <span class="n">c</span> <span class="o">=</span> <span class="p">(</span><span class="mi">4</span><span class="p">,</span> <span class="mi">4</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">f</span><span class="p">,</span> <span class="n">c</span> <span class="o">=</span> <span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">ceil</span><span class="p">(</span><span class="n">n</span> <span class="o">/</span> <span class="mi">4</span><span class="p">)),</span> <span class="mi">4</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">f</span><span class="p">,</span> <span class="n">c</span></div>


<div class="viewcode-block" id="PrintMatrices"><a class="viewcode-back" href="../../py_pol.html#py_pol.utils.PrintMatrices">[docs]</a><span class="k">def</span> <span class="nf">PrintMatrices</span><span class="p">(</span><span class="nb">list</span><span class="p">,</span> <span class="n">Nspaces</span><span class="o">=</span><span class="mi">3</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Creates the print string of a list of matrices to be printed in a line.</span>

<span class="sd">    Parameters:</span>
<span class="sd">        list (list): list of matrices.</span>
<span class="sd">        Nspaces (int): Number of spaces between matrices.</span>

<span class="sd">    Returns:</span>
<span class="sd">        str (string): String to be printed.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">N</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="nb">list</span><span class="p">)</span>
    <span class="n">s</span> <span class="o">=</span> <span class="nb">list</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">shape</span>
    <span class="nb">str</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span>
    <span class="k">for</span> <span class="n">r</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">s</span><span class="p">[</span><span class="mi">0</span><span class="p">]):</span>
        <span class="k">for</span> <span class="n">M</span> <span class="ow">in</span> <span class="nb">list</span><span class="p">:</span>
            <span class="c1"># Start of matrix</span>
            <span class="nb">str</span> <span class="o">=</span> <span class="nb">str</span> <span class="o">+</span> <span class="s1">&#39;[&#39;</span>
            <span class="c1"># Row of matrix</span>
            <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">s</span><span class="p">[</span><span class="mi">1</span><span class="p">]):</span>
                <span class="nb">str</span> <span class="o">=</span> <span class="nb">str</span> <span class="o">+</span> <span class="s1">&#39;</span><span class="si">{:+1.3f}</span><span class="s1"> &#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">M</span><span class="p">[</span><span class="n">r</span><span class="p">,</span> <span class="n">c</span><span class="p">])</span>
            <span class="c1"># End of matrix</span>
            <span class="nb">str</span> <span class="o">=</span> <span class="nb">str</span> <span class="o">+</span> <span class="s1">&#39;</span><span class="se">\b</span><span class="s1">]&#39;</span>
            <span class="nb">str</span> <span class="o">=</span> <span class="nb">str</span> <span class="o">+</span> <span class="n">Nspaces</span> <span class="o">*</span> <span class="s1">&#39; &#39;</span>
        <span class="c1"># End of line</span>
        <span class="nb">str</span> <span class="o">=</span> <span class="nb">str</span> <span class="o">+</span> <span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span>
    <span class="k">return</span> <span class="nb">str</span></div>


<div class="viewcode-block" id="rotation_matrix_Jones"><a class="viewcode-back" href="../../py_pol.html#py_pol.utils.rotation_matrix_Jones">[docs]</a><span class="k">def</span> <span class="nf">rotation_matrix_Jones</span><span class="p">(</span><span class="n">angle</span><span class="p">,</span> <span class="n">length</span><span class="o">=</span><span class="mi">1</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Creates an array of Jones 2x2 rotation matrices.</span>

<span class="sd">    Parameters:</span>
<span class="sd">        angle (np.array): array of angle of rotation, in radians.</span>
<span class="sd">        length (int): If some variables must be expanded but all of them have length 1, this will be the length of the new variables.</span>

<span class="sd">    Returns:</span>
<span class="sd">        numpy.array: 2x2xN matrix</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">angle</span> <span class="o">=</span> <span class="n">prepare_variables</span><span class="p">([</span><span class="n">angle</span><span class="p">],</span> <span class="n">length</span><span class="o">=</span><span class="n">length</span><span class="p">)</span>
    <span class="n">M</span> <span class="o">=</span> <span class="n">array</span><span class="p">([[</span><span class="n">cos</span><span class="p">(</span><span class="n">angle</span><span class="p">),</span> <span class="n">sin</span><span class="p">(</span><span class="n">angle</span><span class="p">)],</span> <span class="p">[</span><span class="o">-</span><span class="n">sin</span><span class="p">(</span><span class="n">angle</span><span class="p">),</span> <span class="n">cos</span><span class="p">(</span><span class="n">angle</span><span class="p">)]])</span>
    <span class="k">return</span> <span class="n">M</span></div>


<div class="viewcode-block" id="rotation_matrix_Mueller"><a class="viewcode-back" href="../../py_pol.html#py_pol.utils.rotation_matrix_Mueller">[docs]</a><span class="k">def</span> <span class="nf">rotation_matrix_Mueller</span><span class="p">(</span><span class="n">angle</span><span class="o">=</span><span class="mi">0</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Mueller 4x4 matrix for rotation</span>

<span class="sd">    References:</span>
<span class="sd">        Gil, Ossikovski (4.30) - p. 131</span>
<span class="sd">        Handbook of Optics vol 2. 22.16 (eq.8) is with changed sign in sin</span>

<span class="sd">    Parameters:</span>
<span class="sd">        angle (float): angle of rotation with respect to 0 deg.</span>

<span class="sd">    Returns:</span>
<span class="sd">        (numpy.array): 4x4xN rotation matrix.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1"># Definicion de la matrix</span>
    <span class="n">c2b</span><span class="p">,</span> <span class="n">s2b</span> <span class="o">=</span> <span class="p">(</span><span class="n">cos</span><span class="p">(</span><span class="mi">2</span> <span class="o">*</span> <span class="n">angle</span><span class="p">),</span> <span class="n">sin</span><span class="p">(</span><span class="mi">2</span> <span class="o">*</span> <span class="n">angle</span><span class="p">))</span>
    <span class="n">zero</span><span class="p">,</span> <span class="n">one</span> <span class="o">=</span> <span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">zeros_like</span><span class="p">(</span><span class="n">c2b</span><span class="p">),</span> <span class="n">np</span><span class="o">.</span><span class="n">ones_like</span><span class="p">(</span><span class="n">c2b</span><span class="p">))</span>
    <span class="n">M</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([[</span><span class="n">one</span><span class="p">,</span> <span class="n">zero</span><span class="p">,</span> <span class="n">zero</span><span class="p">,</span> <span class="n">zero</span><span class="p">],</span> <span class="p">[</span><span class="n">zero</span><span class="p">,</span> <span class="n">c2b</span><span class="p">,</span> <span class="n">s2b</span><span class="p">,</span> <span class="n">zero</span><span class="p">],</span>
                  <span class="p">[</span><span class="n">zero</span><span class="p">,</span> <span class="o">-</span><span class="n">s2b</span><span class="p">,</span> <span class="n">c2b</span><span class="p">,</span> <span class="n">zero</span><span class="p">],</span> <span class="p">[</span><span class="n">zero</span><span class="p">,</span> <span class="n">zero</span><span class="p">,</span> <span class="n">zero</span><span class="p">,</span> <span class="n">one</span><span class="p">]],</span>
                 <span class="n">dtype</span><span class="o">=</span><span class="nb">float</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">M</span></div>


<div class="viewcode-block" id="azimuth_elipt_2_charac_angles"><a class="viewcode-back" href="../../py_pol.html#py_pol.utils.azimuth_elipt_2_charac_angles">[docs]</a><span class="k">def</span> <span class="nf">azimuth_elipt_2_charac_angles</span><span class="p">(</span><span class="n">azimuth</span><span class="p">,</span> <span class="n">ellipticity</span><span class="p">,</span> <span class="n">out_number</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Function that converts azimuth and elipticity to characteristic angles in Jones space.</span>

<span class="sd">    .. math:: cos(2 \\alpha) = cos(2 \phi) * cos(2 \chi)</span>

<span class="sd">    .. math:: tan(\delta) = \\frac{tan(2 \chi)}{sin(2 \phi)}</span>

<span class="sd">    TODO: Improve the 2D way of calculating</span>

<span class="sd">    References:</span>
<span class="sd">        J.J. Gil, R. Ossikovsky &quot;Polarized light and the Mueller Matrix approach&quot;, CRC Press (2016), pp 137 and 1543.</span>


<span class="sd">    Parameters:</span>
<span class="sd">        azimuth (float or numpy.ndarray) [0,np.pi]: Azimuth (angle of rotation).</span>
<span class="sd">        ellipticity (float or numpy.ndarray) [-pi/4,np.pi/4]: Elipticity angle.</span>
<span class="sd">        out_number (bool): if True and the result is a 1x1 array, return a number instead. Default: True.</span>


<span class="sd">    Returns:</span>
<span class="sd">        alpha (float) [0,np.pi]: tan(alpha) is the ratio between the maximum amplitudes of the polarization elipse in X-Y coordinates.</span>
<span class="sd">        delta (float) [0, 2*pi]: phase difference between both components of the eigenstates in Jones formalism.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1"># Prepare variables</span>
    <span class="p">(</span><span class="n">azimuth</span><span class="p">,</span>
     <span class="n">ellipticity</span><span class="p">),</span> <span class="n">shape</span> <span class="o">=</span> <span class="n">prepare_variables</span><span class="p">(</span><span class="nb">vars</span><span class="o">=</span><span class="p">[</span><span class="n">azimuth</span><span class="p">,</span> <span class="n">ellipticity</span><span class="p">],</span>
                                             <span class="n">expand</span><span class="o">=</span><span class="p">[</span><span class="kc">True</span><span class="p">,</span> <span class="kc">True</span><span class="p">],</span>
                                             <span class="n">give_shape</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="c1"># Check that the angles belong to the correct interval. If not, fix it.</span>
    <span class="n">azimuth</span> <span class="o">=</span> <span class="n">put_in_limits</span><span class="p">(</span><span class="n">azimuth</span><span class="p">,</span> <span class="s2">&quot;azimuth&quot;</span><span class="p">,</span> <span class="n">out_number</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
    <span class="n">ellipticity</span> <span class="o">=</span> <span class="n">put_in_limits</span><span class="p">(</span><span class="n">ellipticity</span><span class="p">,</span> <span class="s2">&quot;ellipticity&quot;</span><span class="p">,</span> <span class="n">out_number</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
    <span class="c1"># Initialize variables</span>
    <span class="n">alpha</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros_like</span><span class="p">(</span><span class="n">azimuth</span><span class="p">)</span>  <span class="c1"># * np.nan</span>
    <span class="n">delta</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros_like</span><span class="p">(</span><span class="n">azimuth</span><span class="p">)</span>  <span class="c1"># * np.nan</span>
    <span class="c1"># Start by checking the particular cases of the exteme values</span>
    <span class="c1"># Check linear polarization case</span>
    <span class="n">cond1</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">ellipticity</span><span class="p">)</span> <span class="o">&lt;</span> <span class="n">tol_default</span><span class="o">**</span><span class="mi">2</span>
    <span class="n">alpha</span><span class="p">[</span><span class="n">cond1</span><span class="p">]</span> <span class="o">=</span> <span class="n">azimuth</span><span class="p">[</span><span class="n">cond1</span><span class="p">]</span>
    <span class="n">cond2</span> <span class="o">=</span> <span class="n">cond1</span> <span class="o">*</span> <span class="p">(</span><span class="n">azimuth</span> <span class="o">&gt;</span> <span class="n">np</span><span class="o">.</span><span class="n">pi</span> <span class="o">/</span> <span class="mi">2</span><span class="p">)</span>
    <span class="n">delta</span><span class="p">[</span><span class="n">cond2</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">pi</span>
    <span class="c1"># Check circular polarization case</span>
    <span class="n">cond2</span> <span class="o">=</span> <span class="p">(</span><span class="o">~</span><span class="n">cond1</span><span class="p">)</span> <span class="o">*</span> <span class="p">((</span><span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">ellipticity</span> <span class="o">+</span> <span class="n">np</span><span class="o">.</span><span class="n">pi</span> <span class="o">/</span> <span class="mi">4</span><span class="p">)</span> <span class="o">&lt;</span> <span class="n">tol_default</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span> <span class="o">+</span>
                        <span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">ellipticity</span> <span class="o">-</span> <span class="n">np</span><span class="o">.</span><span class="n">pi</span> <span class="o">/</span> <span class="mi">4</span><span class="p">)</span> <span class="o">&lt;</span> <span class="n">tol_default</span><span class="o">**</span><span class="mi">2</span><span class="p">))</span>
    <span class="n">alpha</span><span class="p">[</span><span class="n">cond2</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">pi</span> <span class="o">/</span> <span class="mi">4</span>
    <span class="n">delta</span><span class="p">[</span><span class="n">cond2</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">pi</span> <span class="o">/</span> <span class="mi">2</span> <span class="o">+</span> <span class="p">((</span><span class="mi">1</span> <span class="o">-</span> <span class="n">np</span><span class="o">.</span><span class="n">sign</span><span class="p">(</span><span class="n">ellipticity</span><span class="p">[</span><span class="n">cond2</span><span class="p">]))</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">pi</span> <span class="o">/</span> <span class="mi">2</span><span class="p">)</span>
    <span class="c1"># Calculate values using trigonometric functions</span>
    <span class="n">cond3</span> <span class="o">=</span> <span class="p">(</span><span class="o">~</span><span class="n">cond1</span><span class="p">)</span> <span class="o">*</span> <span class="p">(</span><span class="o">~</span><span class="n">cond2</span><span class="p">)</span>
    <span class="n">alpha</span><span class="p">[</span><span class="n">cond3</span><span class="p">]</span> <span class="o">=</span> <span class="mf">0.5</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">arccos</span><span class="p">(</span>
        <span class="n">np</span><span class="o">.</span><span class="n">cos</span><span class="p">(</span><span class="mi">2</span> <span class="o">*</span> <span class="n">azimuth</span><span class="p">[</span><span class="n">cond3</span><span class="p">])</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">cos</span><span class="p">(</span><span class="mi">2</span> <span class="o">*</span> <span class="n">ellipticity</span><span class="p">[</span><span class="n">cond3</span><span class="p">]))</span>
    <span class="c1"># Avoid dividing by 0</span>
    <span class="n">cond4</span> <span class="o">=</span> <span class="n">cond3</span> <span class="o">*</span> <span class="p">((</span><span class="n">azimuth</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="o">+</span> <span class="p">(</span><span class="n">azimuth</span> <span class="o">==</span> <span class="n">np</span><span class="o">.</span><span class="n">pi</span><span class="p">))</span>
    <span class="n">delta</span><span class="p">[</span><span class="n">cond4</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sign</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">tan</span><span class="p">(</span><span class="mi">2</span> <span class="o">*</span> <span class="n">ellipticity</span><span class="p">[</span><span class="n">cond4</span><span class="p">]))</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">pi</span> <span class="o">/</span> <span class="mi">2</span>
    <span class="n">cond4</span> <span class="o">=</span> <span class="p">(</span><span class="o">~</span><span class="n">cond4</span><span class="p">)</span> <span class="o">*</span> <span class="n">cond3</span>
    <span class="n">delta</span><span class="p">[</span><span class="n">cond4</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arctan</span><span class="p">(</span>
        <span class="n">np</span><span class="o">.</span><span class="n">tan</span><span class="p">(</span><span class="mi">2</span> <span class="o">*</span> <span class="n">ellipticity</span><span class="p">[</span><span class="n">cond4</span><span class="p">])</span> <span class="o">/</span> <span class="n">np</span><span class="o">.</span><span class="n">sin</span><span class="p">(</span><span class="mi">2</span> <span class="o">*</span> <span class="n">azimuth</span><span class="p">[</span><span class="n">cond4</span><span class="p">]))</span>
    <span class="c1"># Use the other possible value from the arcs functions if necessary</span>
    <span class="n">Qel</span> <span class="o">=</span> <span class="n">which_quad</span><span class="p">(</span><span class="n">ellipticity</span><span class="p">)</span>
    <span class="n">Qaz</span> <span class="o">=</span> <span class="n">which_quad</span><span class="p">(</span><span class="n">azimuth</span><span class="p">)</span>
    <span class="c1"># Adjust</span>
    <span class="n">cond1</span> <span class="o">=</span> <span class="n">Qaz</span> <span class="o">&gt;=</span> <span class="mi">3</span>
    <span class="n">delta</span><span class="p">[</span><span class="n">cond1</span><span class="p">]</span> <span class="o">=</span> <span class="n">delta</span><span class="p">[</span><span class="n">cond1</span><span class="p">]</span> <span class="o">+</span> <span class="n">np</span><span class="o">.</span><span class="n">pi</span>
    <span class="n">cond1</span> <span class="o">=</span> <span class="n">Qel</span> <span class="o">==</span> <span class="mf">1.5</span>
    <span class="n">delta</span><span class="p">[</span><span class="n">cond1</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">pi</span> <span class="o">/</span> <span class="mi">2</span>
    <span class="n">cond1</span> <span class="o">=</span> <span class="n">Qel</span> <span class="o">==</span> <span class="o">-</span><span class="mf">1.5</span>
    <span class="n">delta</span><span class="p">[</span><span class="n">cond1</span><span class="p">]</span> <span class="o">=</span> <span class="mi">3</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">pi</span> <span class="o">/</span> <span class="mi">2</span>
    <span class="n">cond1</span> <span class="o">=</span> <span class="p">(</span><span class="n">Qaz</span> <span class="o">&gt;=</span> <span class="mi">3</span><span class="p">)</span> <span class="o">*</span> <span class="p">(</span><span class="n">Qel</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
    <span class="n">delta</span><span class="p">[</span><span class="n">cond1</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">pi</span>

    <span class="c1"># Make sure the output values are in the allowed limits</span>
    <span class="n">alpha</span> <span class="o">=</span> <span class="n">put_in_limits</span><span class="p">(</span><span class="n">alpha</span><span class="p">,</span> <span class="s2">&quot;alpha&quot;</span><span class="p">,</span> <span class="n">out_number</span><span class="o">=</span><span class="n">out_number</span><span class="p">)</span>
    <span class="n">delta</span> <span class="o">=</span> <span class="n">put_in_limits</span><span class="p">(</span><span class="n">delta</span><span class="p">,</span> <span class="s2">&quot;delta&quot;</span><span class="p">,</span> <span class="n">out_number</span><span class="o">=</span><span class="n">out_number</span><span class="p">)</span>
    <span class="c1"># Recover the shape</span>
    <span class="n">alpha</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="n">alpha</span><span class="p">,</span> <span class="n">shape</span><span class="p">)</span>
    <span class="n">delta</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="n">delta</span><span class="p">,</span> <span class="n">shape</span><span class="p">)</span>
    <span class="c1"># End</span>
    <span class="k">return</span> <span class="n">alpha</span><span class="p">,</span> <span class="n">delta</span></div>


<div class="viewcode-block" id="charac_angles_2_azimuth_elipt"><a class="viewcode-back" href="../../py_pol.html#py_pol.utils.charac_angles_2_azimuth_elipt">[docs]</a><span class="k">def</span> <span class="nf">charac_angles_2_azimuth_elipt</span><span class="p">(</span><span class="n">alpha</span><span class="p">,</span> <span class="n">delta</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Function that converts azimuth and elipticity to characteristic angles in Jones space.</span>

<span class="sd">    .. math:: cos(2 \\alpha) = cos(2 \phi) * cos(2 \chi)</span>

<span class="sd">    .. math:: tan(\delta) = \\frac{tan(2 \chi)}{sin(2 \phi)}</span>


<span class="sd">    References:</span>
<span class="sd">        J. J. Gil, &quot;Polarized light and the Mueller Matrix approach&quot;, pp 137 and 154.</span>

<span class="sd">    Parameters:</span>
<span class="sd">        alpha (float) [0,np.pi]: tan(alpha) is the ratio between the maximum</span>
<span class="sd">        amplitudes of the polarization elipse in X-Y coordinates.</span>
<span class="sd">        delta (float) [0, 2*pi]: phase difference between both components of</span>
<span class="sd">            the eigenstates in Jones formalism.</span>

<span class="sd">    Returns:</span>
<span class="sd">        azimuth (float) [0,np.pi]: Azimuth (angle of rotation).</span>
<span class="sd">        ellipticity (float) [-pi/4,np.pi/4]: Elipticity angle.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1"># Prepare variables</span>
    <span class="p">(</span><span class="n">alpha</span><span class="p">,</span> <span class="n">delta</span><span class="p">),</span> <span class="n">shape</span> <span class="o">=</span> <span class="n">prepare_variables</span><span class="p">(</span><span class="nb">vars</span><span class="o">=</span><span class="p">[</span><span class="n">alpha</span><span class="p">,</span> <span class="n">delta</span><span class="p">],</span>
                                              <span class="n">expand</span><span class="o">=</span><span class="p">[</span><span class="kc">True</span><span class="p">,</span> <span class="kc">True</span><span class="p">],</span>
                                              <span class="n">give_shape</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="c1"># Check that the angles belong to the correct interval. If not, fix it.</span>
    <span class="n">alpha</span> <span class="o">=</span> <span class="n">put_in_limits</span><span class="p">(</span><span class="n">alpha</span><span class="p">,</span> <span class="s2">&quot;alpha&quot;</span><span class="p">,</span> <span class="n">out_number</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
    <span class="n">delta</span> <span class="o">=</span> <span class="n">put_in_limits</span><span class="p">(</span><span class="n">delta</span><span class="p">,</span> <span class="s2">&quot;delta&quot;</span><span class="p">,</span> <span class="n">out_number</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
    <span class="n">azimuth</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros_like</span><span class="p">(</span><span class="n">alpha</span><span class="p">)</span>
    <span class="n">ellipticity</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros_like</span><span class="p">(</span><span class="n">alpha</span><span class="p">)</span>
    <span class="c1"># Check circular polarization case</span>
    <span class="n">cond1</span> <span class="o">=</span> <span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">alpha</span> <span class="o">-</span> <span class="n">np</span><span class="o">.</span><span class="n">pi</span> <span class="o">/</span> <span class="mi">4</span><span class="p">)</span> <span class="o">&lt;</span> <span class="n">tol_default</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span> <span class="o">*</span> <span class="p">(</span>
        <span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">delta</span> <span class="o">-</span> <span class="n">np</span><span class="o">.</span><span class="n">pi</span> <span class="o">/</span> <span class="mi">2</span><span class="p">)</span> <span class="o">&lt;</span> <span class="n">tol_default</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span> <span class="o">+</span>
        <span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">delta</span> <span class="o">-</span> <span class="mi">3</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">pi</span> <span class="o">/</span> <span class="mi">2</span><span class="p">)</span> <span class="o">&lt;</span> <span class="n">tol_default</span><span class="o">**</span><span class="mi">2</span><span class="p">))</span>
    <span class="n">ellipticity</span><span class="p">[</span><span class="n">cond1</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sign</span><span class="p">(</span><span class="n">delta</span><span class="p">[</span><span class="n">cond1</span><span class="p">]</span> <span class="o">-</span> <span class="n">np</span><span class="o">.</span><span class="n">pi</span><span class="p">)</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">pi</span> <span class="o">/</span> <span class="mi">4</span>
    <span class="c1"># Check the linear polarization at 0 and 90º case</span>
    <span class="n">cond2</span> <span class="o">=</span> <span class="p">(</span><span class="n">alpha</span> <span class="o">&lt;</span> <span class="n">tol_default</span><span class="p">)</span> <span class="o">+</span> <span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">alpha</span> <span class="o">-</span> <span class="n">np</span><span class="o">.</span><span class="n">pi</span> <span class="o">/</span> <span class="mi">2</span><span class="p">)</span> <span class="o">&lt;</span> <span class="n">tol_default</span><span class="p">)</span>
    <span class="n">azimuth</span><span class="p">[</span><span class="n">cond2</span><span class="p">]</span> <span class="o">=</span> <span class="n">alpha</span><span class="p">[</span><span class="n">cond2</span><span class="p">]</span>
    <span class="c1"># Calculate values using trigonometric functions</span>
    <span class="n">cond1</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">logical_not</span><span class="p">(</span><span class="n">cond1</span> <span class="o">+</span> <span class="n">cond2</span><span class="p">)</span>
    <span class="n">azimuth</span><span class="p">[</span><span class="n">cond1</span><span class="p">]</span> <span class="o">=</span> <span class="mf">0.5</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">arctan</span><span class="p">(</span><span class="n">tan</span><span class="p">(</span><span class="mi">2</span> <span class="o">*</span> <span class="n">alpha</span><span class="p">[</span><span class="n">cond1</span><span class="p">])</span> <span class="o">*</span> <span class="n">cos</span><span class="p">(</span><span class="n">delta</span><span class="p">[</span><span class="n">cond1</span><span class="p">]))</span>
    <span class="n">ellipticity</span><span class="p">[</span><span class="n">cond1</span><span class="p">]</span> <span class="o">=</span> <span class="mf">0.5</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">arcsin</span><span class="p">(</span>
        <span class="n">sin</span><span class="p">(</span><span class="mi">2</span> <span class="o">*</span> <span class="n">alpha</span><span class="p">[</span><span class="n">cond1</span><span class="p">])</span> <span class="o">*</span> <span class="n">sin</span><span class="p">(</span><span class="n">delta</span><span class="p">[</span><span class="n">cond1</span><span class="p">]))</span>
    <span class="c1"># Use the other possible value from the arcs functions if necessary</span>
    <span class="n">Qalpha</span> <span class="o">=</span> <span class="n">which_quad</span><span class="p">(</span><span class="n">alpha</span><span class="p">)</span>
    <span class="n">Mdelta</span> <span class="o">=</span> <span class="n">which_quad</span><span class="p">(</span><span class="n">delta</span><span class="p">,</span> <span class="n">octant</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
    <span class="n">cond2</span> <span class="o">=</span> <span class="n">Qalpha</span> <span class="o">==</span> <span class="mi">2</span>
    <span class="n">azimuth</span><span class="p">[</span><span class="n">cond1</span> <span class="o">*</span> <span class="n">cond2</span><span class="p">]</span> <span class="o">=</span> <span class="n">azimuth</span><span class="p">[</span><span class="n">cond1</span> <span class="o">*</span> <span class="n">cond2</span><span class="p">]</span> <span class="o">+</span> <span class="n">np</span><span class="o">.</span><span class="n">pi</span> <span class="o">/</span> <span class="mi">2</span>
    <span class="n">cond2</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">logical_not</span><span class="p">(</span><span class="n">cond2</span><span class="p">)</span>
    <span class="n">cond3</span> <span class="o">=</span> <span class="p">(</span><span class="n">Mdelta</span> <span class="o">==</span> <span class="mi">2</span><span class="p">)</span> <span class="o">+</span> <span class="p">(</span><span class="n">Mdelta</span> <span class="o">==</span> <span class="mi">3</span><span class="p">)</span>
    <span class="n">azimuth</span><span class="p">[</span><span class="n">cond1</span> <span class="o">*</span> <span class="n">cond2</span> <span class="o">*</span> <span class="n">cond3</span><span class="p">]</span> <span class="o">=</span> <span class="n">azimuth</span><span class="p">[</span><span class="n">cond1</span> <span class="o">*</span> <span class="n">cond2</span> <span class="o">*</span> <span class="n">cond3</span><span class="p">]</span> <span class="o">+</span> <span class="n">np</span><span class="o">.</span><span class="n">pi</span>
    <span class="n">cond2</span> <span class="o">=</span> <span class="p">(</span><span class="n">Mdelta</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="o">+</span> <span class="p">(</span><span class="n">Qalpha</span> <span class="o">==</span> <span class="mf">2.5</span><span class="p">)</span>
    <span class="n">azimuth</span><span class="p">[</span><span class="n">cond1</span> <span class="o">*</span> <span class="n">cond2</span><span class="p">]</span> <span class="o">=</span> <span class="n">azimuth</span><span class="p">[</span><span class="n">cond1</span> <span class="o">*</span> <span class="n">cond2</span><span class="p">]</span> <span class="o">+</span> <span class="n">np</span><span class="o">.</span><span class="n">pi</span>
    <span class="n">cond2</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">logical_not</span><span class="p">(</span><span class="n">cond2</span><span class="p">)</span>
    <span class="n">cond3</span> <span class="o">=</span> <span class="p">((</span><span class="n">Mdelta</span> <span class="o">==</span> <span class="mf">1.5</span><span class="p">)</span> <span class="o">+</span> <span class="p">(</span><span class="n">Mdelta</span> <span class="o">==</span> <span class="mf">2.5</span><span class="p">)</span> <span class="o">+</span>
             <span class="p">(</span><span class="n">Mdelta</span> <span class="o">==</span> <span class="mf">3.5</span><span class="p">))</span> <span class="o">*</span> <span class="p">((</span><span class="n">Qalpha</span> <span class="o">==</span> <span class="mf">1.5</span><span class="p">)</span> <span class="o">+</span> <span class="p">(</span><span class="n">Qalpha</span> <span class="o">==</span> <span class="mf">2.5</span><span class="p">))</span>
    <span class="n">azimuth</span><span class="p">[</span><span class="n">cond1</span> <span class="o">*</span> <span class="n">cond2</span> <span class="o">*</span> <span class="n">cond3</span><span class="p">]</span> <span class="o">=</span> <span class="n">azimuth</span><span class="p">[</span><span class="n">cond1</span> <span class="o">*</span> <span class="n">cond2</span> <span class="o">*</span> <span class="n">cond3</span><span class="p">]</span> <span class="o">+</span> <span class="n">np</span><span class="o">.</span><span class="n">pi</span>
    <span class="n">cond</span> <span class="o">=</span> <span class="p">(</span><span class="n">Qalpha</span> <span class="o">==</span> <span class="mf">1.5</span><span class="p">)</span> <span class="o">*</span> <span class="p">(</span><span class="n">Mdelta</span> <span class="o">==</span> <span class="mf">1.5</span><span class="p">)</span>
    <span class="n">ellipticity</span><span class="p">[</span><span class="n">cond</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">pi</span> <span class="o">/</span> <span class="mi">4</span>
    <span class="n">azimuth</span><span class="p">[</span><span class="n">cond</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">pi</span> <span class="o">/</span> <span class="mi">4</span>
    <span class="n">cond</span> <span class="o">=</span> <span class="p">(</span><span class="n">Qalpha</span> <span class="o">==</span> <span class="mf">1.5</span><span class="p">)</span> <span class="o">*</span> <span class="p">(</span><span class="n">Mdelta</span> <span class="o">==</span> <span class="mf">3.5</span><span class="p">)</span>
    <span class="n">ellipticity</span><span class="p">[</span><span class="n">cond</span><span class="p">]</span> <span class="o">=</span> <span class="o">-</span><span class="n">np</span><span class="o">.</span><span class="n">pi</span> <span class="o">/</span> <span class="mi">4</span>
    <span class="n">azimuth</span><span class="p">[</span><span class="n">cond</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">pi</span> <span class="o">/</span> <span class="mi">4</span>
    <span class="n">cond</span> <span class="o">=</span> <span class="p">(</span><span class="n">Qalpha</span> <span class="o">==</span> <span class="mf">1.5</span><span class="p">)</span> <span class="o">*</span> <span class="p">(</span><span class="n">Mdelta</span> <span class="o">&gt;=</span> <span class="mf">1.5</span><span class="p">)</span> <span class="o">*</span> <span class="p">(</span><span class="n">Mdelta</span> <span class="o">&lt;=</span> <span class="mf">3.5</span><span class="p">)</span>
    <span class="n">azimuth</span><span class="p">[</span><span class="n">cond</span><span class="p">]</span> <span class="o">=</span> <span class="mi">3</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">pi</span> <span class="o">/</span> <span class="mi">4</span>

    <span class="c1"># if np.abs(alpha - np.pi / 4) &lt; tol_default and (</span>
    <span class="c1">#         np.abs(delta - np.pi / 2) &lt; tol_default</span>
    <span class="c1">#         or np.abs(delta - 3 * np.pi / 2) &lt; tol_default):</span>
    <span class="c1">#     azimuth = np.nan</span>
    <span class="c1">#     ellipticity = np.sign(delta - np.pi) * np.pi / 4</span>
    <span class="c1"># else:</span>
    <span class="c1">#     # Calculate values using trigonometric functions</span>
    <span class="c1">#     azimuth = 0.5 * np.arctan(tan(2 * alpha) * cos(delta))</span>
    <span class="c1">#     ellipticity = 0.5 * np.arcsin(sin(2 * alpha) * sin(delta))</span>
    <span class="c1">#     # Use the other possible value from the arcs functions if necessary</span>
    <span class="c1">#     Qalpha = which_quad(alpha)</span>
    <span class="c1">#     Mdelta = which_quad(delta, octant=False)</span>
    <span class="c1">#     if Qalpha == 2:</span>
    <span class="c1">#         azimuth += np.pi / 2</span>
    <span class="c1">#     else:</span>
    <span class="c1">#         if Mdelta == 2 or Mdelta == 3:</span>
    <span class="c1">#             azimuth += np.pi</span>
    <span class="c1">#     if Mdelta == 0 and Qalpha == 2.5:</span>
    <span class="c1">#         azimuth += np.pi</span>
    <span class="c1">#     elif Mdelta == 1.5 or Mdelta == 2.5 or Mdelta == 3.5:</span>
    <span class="c1">#         if Qalpha == 1.5 or Qalpha == 2.5:</span>
    <span class="c1">#             azimuth += np.pi</span>
    <span class="c1"># Check that the outpit values are in the correct interval</span>
    <span class="n">azimuth</span> <span class="o">=</span> <span class="n">put_in_limits</span><span class="p">(</span><span class="n">azimuth</span><span class="p">,</span> <span class="s2">&quot;azimuth&quot;</span><span class="p">)</span>
    <span class="n">ellipticity</span> <span class="o">=</span> <span class="n">put_in_limits</span><span class="p">(</span><span class="n">ellipticity</span><span class="p">,</span> <span class="s2">&quot;ellipticity&quot;</span><span class="p">)</span>
    <span class="c1"># Reshape and return</span>
    <span class="n">azimuth</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="n">azimuth</span><span class="p">,</span> <span class="n">shape</span><span class="p">)</span>
    <span class="n">ellipticity</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="n">ellipticity</span><span class="p">,</span> <span class="n">shape</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">azimuth</span><span class="p">,</span> <span class="n">ellipticity</span></div>


<div class="viewcode-block" id="extract_azimuth_elipt"><a class="viewcode-back" href="../../py_pol.html#py_pol.utils.extract_azimuth_elipt">[docs]</a><span class="k">def</span> <span class="nf">extract_azimuth_elipt</span><span class="p">(</span><span class="n">vector</span><span class="p">,</span> <span class="n">use_nan</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Function that extracts azimuth and ellipticity from a diattenuation, polarizance or retardance vector. All of them are of the form of: TODO.</span>

<span class="sd">    .. math:: cos(2 \\alpha) = cos(2 \phi) * cos(2 \chi)</span>

<span class="sd">    .. math:: tan(\delay) = \\tan(2 \chi) / sin(2 \phi)</span>


<span class="sd">    References:</span>
<span class="sd">        J. J. Gil, &quot;Polarized light and the Mueller Matrix approach&quot;, pp 128 and 142.</span>

<span class="sd">    Parameters:</span>
<span class="sd">        vector (np.array 1x3 or 3x1): vector to be measured</span>

<span class="sd">    Returns:</span>
<span class="sd">        azimuth (float) [0,np.pi]: Azimuth (angle of rotation).</span>
<span class="sd">        ellipticity (float) [-pi/4,np.pi/4]: Elipticity angle.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1"># Normalize</span>
    <span class="n">norm</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">norm</span><span class="p">(</span><span class="n">vector</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
    <span class="n">cond</span> <span class="o">=</span> <span class="n">norm</span> <span class="o">&gt;</span> <span class="n">tol_default</span>
    <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">any</span><span class="p">(</span><span class="n">cond</span><span class="p">):</span>
        <span class="n">vector</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="p">:][</span><span class="n">cond</span><span class="p">]</span> <span class="o">/=</span> <span class="n">norm</span><span class="p">[</span><span class="n">cond</span><span class="p">]</span>
        <span class="n">vector</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="p">:][</span><span class="n">cond</span><span class="p">]</span> <span class="o">/=</span> <span class="n">norm</span><span class="p">[</span><span class="n">cond</span><span class="p">]</span>
        <span class="n">vector</span><span class="p">[</span><span class="mi">2</span><span class="p">,</span> <span class="p">:][</span><span class="n">cond</span><span class="p">]</span> <span class="o">/=</span> <span class="n">norm</span><span class="p">[</span><span class="n">cond</span><span class="p">]</span>

    <span class="c1"># Start by calculating ellipticity, which is isolated</span>
    <span class="n">ellipticity</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arcsin</span><span class="p">(</span><span class="n">vector</span><span class="p">[</span><span class="mi">2</span><span class="p">,</span> <span class="p">:])</span> <span class="o">/</span> <span class="mi">2</span>
    <span class="c1"># Now, calculate azimuth using the first therm, as it has the cos</span>
    <span class="n">azimuth</span> <span class="o">=</span> <span class="mf">0.5</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">arccos</span><span class="p">(</span><span class="n">vector</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="p">:]</span> <span class="o">/</span> <span class="n">np</span><span class="o">.</span><span class="n">cos</span><span class="p">(</span><span class="mi">2</span> <span class="o">*</span> <span class="n">ellipticity</span><span class="p">))</span>
    <span class="c1"># # Adjust when we have azimuths over 90º</span>
    <span class="n">cond</span> <span class="o">=</span> <span class="n">vector</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="p">:]</span> <span class="o">&lt;</span> <span class="mi">0</span>
    <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">any</span><span class="p">(</span><span class="n">cond</span><span class="p">):</span>
        <span class="n">azimuth</span><span class="p">[</span><span class="n">cond</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">pi</span> <span class="o">-</span> <span class="n">azimuth</span><span class="p">[</span><span class="n">cond</span><span class="p">]</span>

    <span class="c1"># Correct nans</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">use_nan</span><span class="p">:</span>
        <span class="n">cond</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">isnan</span><span class="p">(</span><span class="n">azimuth</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">any</span><span class="p">(</span><span class="n">cond</span><span class="p">):</span>
            <span class="n">azimuth</span><span class="p">[</span><span class="n">cond</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="n">cond</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">isnan</span><span class="p">(</span><span class="n">ellipticity</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">any</span><span class="p">(</span><span class="n">ellipticity</span><span class="p">):</span>
            <span class="n">ellipticity</span><span class="p">[</span><span class="n">cond</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="k">return</span> <span class="n">azimuth</span><span class="p">,</span> <span class="n">ellipticity</span></div>


<div class="viewcode-block" id="extract_charac_angles"><a class="viewcode-back" href="../../py_pol.html#py_pol.utils.extract_charac_angles">[docs]</a><span class="k">def</span> <span class="nf">extract_charac_angles</span><span class="p">(</span><span class="n">vector</span><span class="p">,</span> <span class="n">use_nan</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="nb">type</span><span class="o">=</span><span class="s1">&#39;diattenuator&#39;</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Function that extracts azimuth and ellipticity from a diattenuation, polarizance or retardance vector. All of them are of the form of: TODO.</span>

<span class="sd">    .. math:: cos(2 \\alpha) = cos(2 \phi) * cos(2 \chi)</span>

<span class="sd">    .. math:: tan(\delay) = \\frac{tan(2 \chi)}{sin(2 \phi)}</span>


<span class="sd">    References:</span>
<span class="sd">        J. J. Gil, &quot;Polarized light and the Mueller Matrix approach&quot;, pp 128 and 142.</span>

<span class="sd">    Parameters:</span>
<span class="sd">        vector (np.array 1x3 or 3x1): vector to be measured</span>

<span class="sd">    Returns:</span>
<span class="sd">        alpha (float) [0,np.pi]: tan(alpha) is the ratio between the maximum amplitudes of the polarization elipse in X-Y coordinates.</span>
<span class="sd">        delay (float) [0, 2*pi]: phase difference between both components of the eigenstates in Jones formalism.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1"># Do it with azimuth and ellipticity and convert</span>
    <span class="n">azimuth</span><span class="p">,</span> <span class="n">ellipticity</span> <span class="o">=</span> <span class="n">extract_azimuth_elipt</span><span class="p">(</span><span class="n">vector</span><span class="o">=</span><span class="n">vector</span><span class="p">,</span>
                                                 <span class="n">use_nan</span><span class="o">=</span><span class="n">use_nan</span><span class="p">,</span>
                                                 <span class="nb">type</span><span class="o">=</span><span class="nb">type</span><span class="p">)</span>
    <span class="n">alpha</span><span class="p">,</span> <span class="n">delay</span> <span class="o">=</span> <span class="n">azimuth_elipt_2_charac_angles</span><span class="p">(</span><span class="n">azimuth</span><span class="p">,</span> <span class="n">ellipticity</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">alpha</span><span class="p">,</span> <span class="n">delay</span></div>


<div class="viewcode-block" id="which_quad"><a class="viewcode-back" href="../../py_pol.html#py_pol.utils.which_quad">[docs]</a><span class="k">def</span> <span class="nf">which_quad</span><span class="p">(</span><span class="n">angle</span><span class="p">,</span> <span class="n">octant</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Auxiliary function to calculate which quadrant or octant angle belongs to.</span>
<span class="sd">    Half angles means that it is exactly between two quarants.</span>

<span class="sd">    Parameters:</span>
<span class="sd">        (float): Angle to determine the quadrant.</span>

<span class="sd">    Returns:</span>
<span class="sd">        (float): Quadrant</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">q</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros_like</span><span class="p">(</span><span class="n">angle</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">octant</span><span class="p">:</span>
        <span class="n">q</span> <span class="o">=</span> <span class="n">q</span> <span class="o">-</span> <span class="mf">4.5</span> <span class="o">*</span> <span class="p">(</span><span class="n">angle</span> <span class="o">&lt;=</span> <span class="o">-</span><span class="n">np</span><span class="o">.</span><span class="n">pi</span> <span class="o">+</span> <span class="n">tol_default</span><span class="p">)</span>
        <span class="n">q</span> <span class="o">=</span> <span class="n">q</span> <span class="o">-</span> <span class="mi">4</span> <span class="o">*</span> <span class="p">(</span><span class="n">angle</span> <span class="o">&gt;</span> <span class="o">-</span><span class="n">np</span><span class="o">.</span><span class="n">pi</span> <span class="o">+</span> <span class="n">tol_default</span><span class="p">)</span> <span class="o">*</span> <span class="p">(</span>
            <span class="n">angle</span> <span class="o">&lt;</span> <span class="o">-</span><span class="n">np</span><span class="o">.</span><span class="n">pi</span> <span class="o">*</span> <span class="mi">3</span> <span class="o">/</span> <span class="mi">4</span> <span class="o">-</span> <span class="n">tol_default</span><span class="p">)</span>
        <span class="n">q</span> <span class="o">=</span> <span class="n">q</span> <span class="o">-</span> <span class="mf">3.5</span> <span class="o">*</span> <span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">angle</span> <span class="o">+</span> <span class="n">np</span><span class="o">.</span><span class="n">pi</span> <span class="o">*</span> <span class="mi">3</span> <span class="o">/</span> <span class="mi">4</span><span class="p">)</span> <span class="o">&lt;=</span> <span class="n">tol_default</span><span class="p">)</span>
        <span class="n">q</span> <span class="o">=</span> <span class="n">q</span> <span class="o">-</span> <span class="mi">3</span> <span class="o">*</span> <span class="p">(</span><span class="n">angle</span> <span class="o">&gt;</span> <span class="o">-</span><span class="n">np</span><span class="o">.</span><span class="n">pi</span> <span class="o">*</span> <span class="mi">3</span> <span class="o">/</span> <span class="mi">4</span> <span class="o">+</span> <span class="n">tol_default</span><span class="p">)</span> <span class="o">*</span> <span class="p">(</span>
            <span class="n">angle</span> <span class="o">&lt;</span> <span class="o">-</span><span class="n">np</span><span class="o">.</span><span class="n">pi</span> <span class="o">/</span> <span class="mi">2</span> <span class="o">-</span> <span class="n">tol_default</span><span class="p">)</span>
        <span class="n">q</span> <span class="o">=</span> <span class="n">q</span> <span class="o">-</span> <span class="mf">2.5</span> <span class="o">*</span> <span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">angle</span> <span class="o">+</span> <span class="n">np</span><span class="o">.</span><span class="n">pi</span> <span class="o">/</span> <span class="mi">2</span><span class="p">)</span> <span class="o">&lt;=</span> <span class="n">tol_default</span><span class="p">)</span>
        <span class="n">q</span> <span class="o">=</span> <span class="n">q</span> <span class="o">-</span> <span class="mi">2</span> <span class="o">*</span> <span class="p">(</span><span class="n">angle</span> <span class="o">&gt;</span> <span class="o">-</span><span class="n">np</span><span class="o">.</span><span class="n">pi</span> <span class="o">/</span> <span class="mi">2</span> <span class="o">+</span> <span class="n">tol_default</span><span class="p">)</span> <span class="o">*</span> <span class="p">(</span>
            <span class="n">angle</span> <span class="o">&lt;</span> <span class="o">-</span><span class="n">np</span><span class="o">.</span><span class="n">pi</span> <span class="o">/</span> <span class="mi">4</span> <span class="o">-</span> <span class="n">tol_default</span><span class="p">)</span>
        <span class="n">q</span> <span class="o">=</span> <span class="n">q</span> <span class="o">-</span> <span class="mf">1.5</span> <span class="o">*</span> <span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">angle</span> <span class="o">+</span> <span class="n">np</span><span class="o">.</span><span class="n">pi</span> <span class="o">/</span> <span class="mi">4</span><span class="p">)</span> <span class="o">&lt;=</span> <span class="n">tol_default</span><span class="p">)</span>
        <span class="n">q</span> <span class="o">=</span> <span class="n">q</span> <span class="o">-</span> <span class="mi">1</span> <span class="o">*</span> <span class="p">(</span><span class="n">angle</span> <span class="o">&gt;</span> <span class="o">-</span><span class="n">np</span><span class="o">.</span><span class="n">pi</span> <span class="o">/</span> <span class="mi">4</span> <span class="o">+</span> <span class="n">tol_default</span><span class="p">)</span> <span class="o">*</span> <span class="p">(</span><span class="n">angle</span> <span class="o">&lt;</span> <span class="o">-</span><span class="n">tol_default</span><span class="p">)</span>
        <span class="n">q</span> <span class="o">=</span> <span class="n">q</span> <span class="o">+</span> <span class="mi">1</span> <span class="o">*</span> <span class="p">(</span><span class="n">angle</span> <span class="o">&gt;</span> <span class="n">tol_default</span><span class="p">)</span> <span class="o">*</span> <span class="p">(</span><span class="n">angle</span> <span class="o">&lt;</span> <span class="n">np</span><span class="o">.</span><span class="n">pi</span> <span class="o">/</span> <span class="mi">4</span> <span class="o">-</span> <span class="n">tol_default</span><span class="p">)</span>
        <span class="n">q</span> <span class="o">=</span> <span class="n">q</span> <span class="o">+</span> <span class="mf">1.5</span> <span class="o">*</span> <span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">angle</span> <span class="o">-</span> <span class="n">np</span><span class="o">.</span><span class="n">pi</span> <span class="o">/</span> <span class="mi">4</span><span class="p">)</span> <span class="o">&lt;=</span> <span class="n">tol_default</span><span class="p">)</span>
        <span class="n">q</span> <span class="o">=</span> <span class="n">q</span> <span class="o">+</span> <span class="mi">2</span> <span class="o">*</span> <span class="p">(</span><span class="n">angle</span> <span class="o">&gt;</span> <span class="n">np</span><span class="o">.</span><span class="n">pi</span> <span class="o">/</span> <span class="mi">4</span> <span class="o">+</span> <span class="n">tol_default</span><span class="p">)</span> <span class="o">*</span> <span class="p">(</span>
            <span class="n">angle</span> <span class="o">&lt;</span> <span class="n">np</span><span class="o">.</span><span class="n">pi</span> <span class="o">/</span> <span class="mi">2</span> <span class="o">-</span> <span class="n">tol_default</span><span class="p">)</span>
        <span class="n">q</span> <span class="o">=</span> <span class="n">q</span> <span class="o">+</span> <span class="mf">2.5</span> <span class="o">*</span> <span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">angle</span> <span class="o">-</span> <span class="n">np</span><span class="o">.</span><span class="n">pi</span> <span class="o">/</span> <span class="mi">2</span><span class="p">)</span> <span class="o">&lt;=</span> <span class="n">tol_default</span><span class="p">)</span>
        <span class="n">q</span> <span class="o">=</span> <span class="n">q</span> <span class="o">+</span> <span class="mi">3</span> <span class="o">*</span> <span class="p">(</span><span class="n">angle</span> <span class="o">&gt;</span> <span class="n">np</span><span class="o">.</span><span class="n">pi</span> <span class="o">/</span> <span class="mi">2</span> <span class="o">+</span> <span class="n">tol_default</span><span class="p">)</span> <span class="o">*</span> <span class="p">(</span>
            <span class="n">angle</span> <span class="o">&lt;</span> <span class="n">np</span><span class="o">.</span><span class="n">pi</span> <span class="o">*</span> <span class="mi">3</span> <span class="o">/</span> <span class="mi">4</span> <span class="o">-</span> <span class="n">tol_default</span><span class="p">)</span>
        <span class="n">q</span> <span class="o">=</span> <span class="n">q</span> <span class="o">+</span> <span class="mf">3.5</span> <span class="o">*</span> <span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">angle</span> <span class="o">-</span> <span class="n">np</span><span class="o">.</span><span class="n">pi</span> <span class="o">*</span> <span class="mi">3</span> <span class="o">/</span> <span class="mi">4</span><span class="p">)</span> <span class="o">&lt;=</span> <span class="n">tol_default</span><span class="p">)</span>
        <span class="n">q</span> <span class="o">=</span> <span class="n">q</span> <span class="o">+</span> <span class="mi">4</span> <span class="o">*</span> <span class="p">(</span><span class="n">angle</span> <span class="o">&gt;</span> <span class="n">np</span><span class="o">.</span><span class="n">pi</span> <span class="o">*</span> <span class="mi">3</span> <span class="o">/</span> <span class="mi">4</span> <span class="o">+</span> <span class="n">tol_default</span><span class="p">)</span> <span class="o">*</span> <span class="p">(</span>
            <span class="n">angle</span> <span class="o">&lt;</span> <span class="n">np</span><span class="o">.</span><span class="n">pi</span> <span class="o">-</span> <span class="n">tol_default</span><span class="p">)</span>
        <span class="n">q</span> <span class="o">=</span> <span class="n">q</span> <span class="o">+</span> <span class="mf">4.5</span> <span class="o">*</span> <span class="p">(</span><span class="n">angle</span> <span class="o">&gt;=</span> <span class="n">np</span><span class="o">.</span><span class="n">pi</span> <span class="o">-</span> <span class="n">tol_default</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">angle</span> <span class="o">=</span> <span class="n">angle</span> <span class="o">%</span> <span class="p">(</span><span class="mi">2</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">pi</span><span class="p">)</span>
        <span class="n">q</span> <span class="o">=</span> <span class="n">q</span> <span class="o">+</span> <span class="mi">1</span> <span class="o">*</span> <span class="p">(</span><span class="n">angle</span> <span class="o">&gt;</span> <span class="n">tol_default</span><span class="p">)</span> <span class="o">*</span> <span class="p">(</span><span class="n">angle</span> <span class="o">&lt;</span> <span class="n">np</span><span class="o">.</span><span class="n">pi</span> <span class="o">/</span> <span class="mi">2</span> <span class="o">-</span> <span class="n">tol_default</span><span class="p">)</span>
        <span class="n">q</span> <span class="o">=</span> <span class="n">q</span> <span class="o">+</span> <span class="mf">1.5</span> <span class="o">*</span> <span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">angle</span> <span class="o">-</span> <span class="n">np</span><span class="o">.</span><span class="n">pi</span> <span class="o">/</span> <span class="mi">2</span><span class="p">)</span> <span class="o">&lt;</span> <span class="n">tol_default</span><span class="p">)</span>
        <span class="n">q</span> <span class="o">=</span> <span class="n">q</span> <span class="o">+</span> <span class="mi">2</span> <span class="o">*</span> <span class="p">(</span><span class="n">angle</span> <span class="o">&gt;</span> <span class="n">np</span><span class="o">.</span><span class="n">pi</span> <span class="o">/</span> <span class="mi">2</span> <span class="o">+</span> <span class="n">tol_default</span><span class="p">)</span> <span class="o">*</span> <span class="p">(</span><span class="n">angle</span> <span class="o">&lt;</span>
                                                         <span class="n">np</span><span class="o">.</span><span class="n">pi</span> <span class="o">-</span> <span class="n">tol_default</span><span class="p">)</span>
        <span class="n">q</span> <span class="o">=</span> <span class="n">q</span> <span class="o">+</span> <span class="mf">2.5</span> <span class="o">*</span> <span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">angle</span> <span class="o">-</span> <span class="n">np</span><span class="o">.</span><span class="n">pi</span><span class="p">)</span> <span class="o">&lt;</span> <span class="n">tol_default</span><span class="p">)</span>
        <span class="n">q</span> <span class="o">=</span> <span class="n">q</span> <span class="o">+</span> <span class="mi">3</span> <span class="o">*</span> <span class="p">(</span><span class="n">angle</span> <span class="o">&gt;</span> <span class="n">np</span><span class="o">.</span><span class="n">pi</span> <span class="o">+</span> <span class="n">tol_default</span><span class="p">)</span> <span class="o">*</span> <span class="p">(</span>
            <span class="n">angle</span> <span class="o">&lt;</span> <span class="n">np</span><span class="o">.</span><span class="n">pi</span> <span class="o">*</span> <span class="mi">3</span> <span class="o">/</span> <span class="mi">2</span> <span class="o">-</span> <span class="n">tol_default</span><span class="p">)</span>
        <span class="n">q</span> <span class="o">=</span> <span class="n">q</span> <span class="o">+</span> <span class="mf">3.5</span> <span class="o">*</span> <span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">angle</span> <span class="o">-</span> <span class="n">np</span><span class="o">.</span><span class="n">pi</span> <span class="o">*</span> <span class="mi">3</span> <span class="o">/</span> <span class="mi">2</span><span class="p">)</span> <span class="o">&lt;</span> <span class="n">tol_default</span><span class="p">)</span>
        <span class="n">q</span> <span class="o">=</span> <span class="n">q</span> <span class="o">+</span> <span class="mi">4</span> <span class="o">*</span> <span class="p">(</span><span class="n">angle</span> <span class="o">&gt;</span> <span class="n">np</span><span class="o">.</span><span class="n">pi</span> <span class="o">*</span> <span class="mi">3</span> <span class="o">/</span> <span class="mi">2</span> <span class="o">+</span> <span class="n">tol_default</span><span class="p">)</span> <span class="o">*</span> <span class="p">(</span>
            <span class="n">angle</span> <span class="o">&lt;</span> <span class="n">np</span><span class="o">.</span><span class="n">pi</span> <span class="o">*</span> <span class="mi">2</span> <span class="o">-</span> <span class="n">tol_default</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">q</span></div>


<div class="viewcode-block" id="put_in_limits"><a class="viewcode-back" href="../../py_pol.html#py_pol.utils.put_in_limits">[docs]</a><span class="k">def</span> <span class="nf">put_in_limits</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">typev</span><span class="p">,</span> <span class="n">out_number</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;When dealing with polarization elipse coordinates, make sure that they</span>
<span class="sd">    are in the valid limits, which are set in the declaration of this class.</span>

<span class="sd">    Parameters:</span>
<span class="sd">        x (1xN array): Value</span>
<span class="sd">        typev (string): Which type of variable is: alpha, delta, azimuth or ellipticity.</span>
<span class="sd">        out_number (bool): if True and the result is a 1x1 array, return a number instead. Default: True.</span>

<span class="sd">    Returns:</span>
<span class="sd">        y (1xN array): Corresponding angle inside the valid limits.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1"># In case it is a number, transform it into an array</span>
    <span class="n">x</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>
    <span class="c1"># Avoid unnecessary nan warnings</span>
    <span class="n">condNan</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">isnan</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>
    <span class="n">x</span><span class="p">[</span><span class="n">condNan</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="c1"># Change x only if necessary</span>
    <span class="k">if</span> <span class="n">typev</span> <span class="ow">in</span> <span class="p">(</span><span class="s2">&quot;alpha&quot;</span><span class="p">,</span> <span class="s2">&quot;Alpha&quot;</span><span class="p">):</span>
        <span class="n">cond</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">logical_or</span><span class="p">(</span><span class="n">x</span> <span class="o">&lt;</span> <span class="n">limAlpha</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">x</span> <span class="o">&gt;=</span> <span class="n">limAlpha</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
        <span class="n">aux</span> <span class="o">=</span> <span class="n">sin</span><span class="p">(</span><span class="n">x</span><span class="p">[</span><span class="n">cond</span><span class="p">])</span>
        <span class="n">x</span><span class="p">[</span><span class="n">cond</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arcsin</span><span class="p">(</span><span class="nb">abs</span><span class="p">(</span><span class="n">aux</span><span class="p">))</span>

    <span class="k">elif</span> <span class="n">typev</span> <span class="ow">in</span> <span class="p">(</span><span class="s2">&quot;delta&quot;</span><span class="p">,</span> <span class="s2">&quot;Delta&quot;</span><span class="p">,</span> <span class="s2">&quot;delay&quot;</span><span class="p">,</span> <span class="s2">&quot;Delay&quot;</span><span class="p">):</span>
        <span class="n">cond</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">logical_or</span><span class="p">(</span><span class="n">x</span> <span class="o">&lt;</span> <span class="n">limDelta</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">x</span> <span class="o">&gt;=</span> <span class="n">limDelta</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
        <span class="n">x</span><span class="p">[</span><span class="n">cond</span><span class="p">]</span> <span class="o">=</span> <span class="n">x</span><span class="p">[</span><span class="n">cond</span><span class="p">]</span> <span class="o">%</span> <span class="p">(</span><span class="mi">2</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">pi</span><span class="p">)</span>

    <span class="k">elif</span> <span class="n">typev</span> <span class="ow">in</span> <span class="p">(</span><span class="s2">&quot;azimuth&quot;</span><span class="p">,</span> <span class="s2">&quot;Az&quot;</span><span class="p">,</span> <span class="s1">&#39;azimuth&#39;</span><span class="p">,</span> <span class="s1">&#39;Azimuth&#39;</span><span class="p">):</span>
        <span class="n">cond</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">logical_or</span><span class="p">(</span><span class="n">x</span> <span class="o">&lt;</span> <span class="n">limAz</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">x</span> <span class="o">&gt;=</span> <span class="n">limAz</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
        <span class="n">aux</span> <span class="o">=</span> <span class="n">cos</span><span class="p">(</span><span class="n">x</span><span class="p">[</span><span class="n">cond</span><span class="p">])</span>
        <span class="n">x</span><span class="p">[</span><span class="n">cond</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arccos</span><span class="p">(</span><span class="o">-</span><span class="n">aux</span><span class="p">)</span>

    <span class="k">elif</span> <span class="n">typev</span> <span class="ow">in</span> <span class="p">(</span><span class="s2">&quot;ellipticity&quot;</span><span class="p">,</span> <span class="s2">&quot;El&quot;</span><span class="p">,</span> <span class="s1">&#39;ellipticity&#39;</span><span class="p">,</span> <span class="s1">&#39;Ellipticity&#39;</span><span class="p">):</span>
        <span class="n">cond</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">logical_or</span><span class="p">(</span><span class="n">x</span> <span class="o">&lt;</span> <span class="n">limEl</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">x</span> <span class="o">&gt;=</span> <span class="n">limEl</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
        <span class="n">aux</span> <span class="o">=</span> <span class="n">tan</span><span class="p">(</span><span class="n">x</span><span class="p">[</span><span class="n">cond</span><span class="p">])</span>
        <span class="n">cond2</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">aux</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">1</span>
        <span class="c1"># print(x / degrees, &#39;\n&#39;, cond, &#39;\n&#39;, cond2)</span>
        <span class="n">aux</span><span class="p">[</span><span class="n">cond2</span><span class="p">]</span> <span class="o">=</span> <span class="mi">1</span> <span class="o">/</span> <span class="n">aux</span><span class="p">[</span><span class="n">cond2</span><span class="p">]</span>
        <span class="n">x</span><span class="p">[</span><span class="n">cond</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arctan</span><span class="p">(</span><span class="n">aux</span><span class="p">)</span>
    <span class="k">elif</span> <span class="n">typev</span> <span class="ow">in</span> <span class="p">(</span><span class="s1">&#39;ret&#39;</span><span class="p">,</span> <span class="s1">&#39;Ret&#39;</span><span class="p">,</span> <span class="s1">&#39;RET&#39;</span><span class="p">,</span> <span class="s1">&#39;Retardance&#39;</span><span class="p">,</span> <span class="s1">&#39;retardance&#39;</span><span class="p">):</span>
        <span class="n">cond</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">logical_or</span><span class="p">(</span><span class="n">x</span> <span class="o">&lt;</span> <span class="n">limRet</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">x</span> <span class="o">&gt;=</span> <span class="n">limRet</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
        <span class="n">aux</span> <span class="o">=</span> <span class="n">cos</span><span class="p">(</span><span class="n">x</span><span class="p">[</span><span class="n">cond</span><span class="p">])</span>
        <span class="n">x</span><span class="p">[</span><span class="n">cond</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arccos</span><span class="p">(</span><span class="o">-</span><span class="n">aux</span><span class="p">)</span>
    <span class="c1"># Recover the nan values</span>
    <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">any</span><span class="p">(</span><span class="n">condNan</span><span class="p">):</span>
        <span class="n">x</span><span class="p">[</span><span class="n">condNan</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span>
    <span class="c1"># If the result is a number and the user asks for it, return a float</span>
    <span class="k">if</span> <span class="n">out_number</span> <span class="ow">and</span> <span class="n">x</span><span class="o">.</span><span class="n">size</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">isnan</span><span class="p">(</span><span class="n">x</span><span class="p">):</span>
            <span class="n">x</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">x</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">x</span></div>


<div class="viewcode-block" id="execute_multiprocessing"><a class="viewcode-back" href="../../py_pol.html#py_pol.utils.execute_multiprocessing">[docs]</a><span class="k">def</span> <span class="nf">execute_multiprocessing</span><span class="p">(</span><span class="n">__function_process__</span><span class="p">,</span>
                            <span class="n">dict_parameters</span><span class="p">,</span>
                            <span class="n">num_processors</span><span class="p">,</span>
                            <span class="n">verbose</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Executes multiprocessing reading a dictionary.</span>

<span class="sd">    Parameters:</span>
<span class="sd">        __function_process__ (func): function to process, it only accepts a dictionary</span>
<span class="sd">        dict_parameters (dict): dictionary / array with parameters</span>
<span class="sd">        num_processors (int): Number of processors. if 1 no multiprocessing is used</span>
<span class="sd">        verbose (bool): Prints processing time.</span>

<span class="sd">    Returns:</span>
<span class="sd">        data: results of multiprocessing</span>
<span class="sd">        (float): processing time</span>

<span class="sd">    Example:</span>

<span class="sd">    .. code-block:: python</span>

<span class="sd">        def __function_process__(xd):</span>
<span class="sd">            x = xd[&#39;x&#39;]</span>
<span class="sd">            y = xd[&#39;y&#39;]</span>
<span class="sd">            # grt = copy.deepcopy(grating)</span>
<span class="sd">            suma = x + y</span>
<span class="sd">            return dict(sumas=suma, ij=xd[&#39;ij&#39;])</span>

<span class="sd">        def creation_dictionary_multiprocessing():</span>
<span class="sd">            # create parameters for multiprocessing</span>
<span class="sd">            t1 = time.time()</span>
<span class="sd">            X = sp.linspace(1, 2, 10)</span>
<span class="sd">            Y = sp.linspace(1, 2, 1000)</span>
<span class="sd">            dict_parameters = []</span>
<span class="sd">            ij = 0</span>
<span class="sd">            for i, x in enumerate(X):</span>
<span class="sd">                for j, y in enumerate(Y):</span>
<span class="sd">                    dict_parameters.append(dict(x=x, y=y, ij=[ij]))</span>
<span class="sd">                    ij += 1</span>
<span class="sd">            t2 = time.time()</span>
<span class="sd">            print &quot;time creation dictionary = {}&quot;.format(t2 - t1)</span>
<span class="sd">            return dict_parameters</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">t1</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>
    <span class="k">if</span> <span class="n">num_processors</span> <span class="o">==</span> <span class="mi">1</span> <span class="ow">or</span> <span class="nb">len</span><span class="p">(</span><span class="n">dict_parameters</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">2</span><span class="p">:</span>
        <span class="n">data_pool</span> <span class="o">=</span> <span class="p">[</span><span class="n">__function_process__</span><span class="p">(</span><span class="n">xd</span><span class="p">)</span> <span class="k">for</span> <span class="n">xd</span> <span class="ow">in</span> <span class="n">dict_parameters</span><span class="p">]</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">pool</span> <span class="o">=</span> <span class="n">multiprocessing</span><span class="o">.</span><span class="n">Pool</span><span class="p">(</span><span class="n">processes</span><span class="o">=</span><span class="n">num_processors</span><span class="p">)</span>
        <span class="n">data_pool</span> <span class="o">=</span> <span class="n">pool</span><span class="o">.</span><span class="n">map</span><span class="p">(</span><span class="n">__function_process__</span><span class="p">,</span> <span class="n">dict_parameters</span><span class="p">)</span>
        <span class="n">pool</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
        <span class="n">pool</span><span class="o">.</span><span class="n">join</span><span class="p">()</span>
    <span class="n">t2</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>
    <span class="k">if</span> <span class="n">verbose</span> <span class="ow">is</span> <span class="kc">True</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;num_proc: </span><span class="si">{}</span><span class="s2">, time=</span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">num_processors</span><span class="p">,</span> <span class="n">t2</span> <span class="o">-</span> <span class="n">t1</span><span class="p">))</span>
    <span class="k">return</span> <span class="n">data_pool</span><span class="p">,</span> <span class="n">t2</span> <span class="o">-</span> <span class="n">t1</span></div>


<div class="viewcode-block" id="divide_in_blocks"><a class="viewcode-back" href="../../py_pol.html#py_pol.utils.divide_in_blocks">[docs]</a><span class="k">def</span> <span class="nf">divide_in_blocks</span><span class="p">(</span><span class="n">M</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Function that creates a mueller matrix from their block components.</span>

<span class="sd">    References: J.J. Gil, R. Ossikovsky &quot;Polarized light and the Mueller Matrix approach&quot;, CRC Press (2016)</span>

<span class="sd">    Parameters:</span>
<span class="sd">        M (4x4 matrix): Mueller matrix of the diattenuator.</span>

<span class="sd">    Returns:</span>
<span class="sd">        Dv (1x3 or 3x1 float): Diattenuation vector.</span>
<span class="sd">        Pv (1x3 or 3x1 float): Diattenuation vector.</span>
<span class="sd">        m (3x3 matrix): Small m matrix.</span>
<span class="sd">        m00 (float, default 1): [0, 1] Parameter of average intensity.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">m00</span> <span class="o">=</span> <span class="n">M</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">]</span>
    <span class="k">if</span> <span class="n">m00</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
        <span class="n">M</span> <span class="o">=</span> <span class="n">M</span> <span class="o">/</span> <span class="n">m00</span>
    <span class="n">Dv</span> <span class="o">=</span> <span class="n">matrix</span><span class="p">(</span><span class="n">M</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">:</span><span class="mi">4</span><span class="p">])</span>
    <span class="n">Pv</span> <span class="o">=</span> <span class="n">matrix</span><span class="p">(</span><span class="n">M</span><span class="p">[</span><span class="mi">1</span><span class="p">:</span><span class="mi">4</span><span class="p">,</span> <span class="mi">0</span><span class="p">])</span>
    <span class="n">m</span> <span class="o">=</span> <span class="n">matrix</span><span class="p">(</span><span class="n">M</span><span class="p">[</span><span class="mi">1</span><span class="p">:</span><span class="mi">4</span><span class="p">,</span> <span class="mi">1</span><span class="p">:</span><span class="mi">4</span><span class="p">])</span>
    <span class="k">return</span> <span class="n">Dv</span><span class="p">,</span> <span class="n">Pv</span><span class="p">,</span> <span class="n">m</span><span class="p">,</span> <span class="n">m00</span></div>


<div class="viewcode-block" id="list_of_objects_depercated"><a class="viewcode-back" href="../../py_pol.html#py_pol.utils.list_of_objects_depercated">[docs]</a><span class="k">def</span> <span class="nf">list_of_objects_depercated</span><span class="p">(</span><span class="n">size</span><span class="p">,</span> <span class="n">type_object</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Creates a list of objects.&quot;&quot;&quot;</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">N</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">size</span><span class="p">)</span>
    <span class="k">except</span><span class="p">:</span>
        <span class="n">N</span> <span class="o">=</span> <span class="mi">1</span>
    <span class="n">dim0</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">if</span> <span class="n">N</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
        <span class="k">for</span> <span class="n">ind</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">size</span><span class="p">):</span>
            <span class="n">dim0</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">type_object</span><span class="p">(</span><span class="s1">&#39; &#39;</span><span class="p">))</span>
    <span class="k">elif</span> <span class="n">N</span> <span class="o">==</span> <span class="mi">2</span><span class="p">:</span>
        <span class="k">for</span> <span class="n">ind</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">size</span><span class="p">[</span><span class="mi">0</span><span class="p">]):</span>
            <span class="n">dim1</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="k">for</span> <span class="n">ind</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">size</span><span class="p">[</span><span class="mi">1</span><span class="p">]):</span>
                <span class="n">dim1</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">type_object</span><span class="p">(</span><span class="s1">&#39; &#39;</span><span class="p">))</span>
            <span class="n">dim0</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">dim1</span><span class="p">)</span>
    <span class="k">elif</span> <span class="n">N</span> <span class="o">==</span> <span class="mi">3</span><span class="p">:</span>
        <span class="k">for</span> <span class="n">ind</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">size</span><span class="p">[</span><span class="mi">0</span><span class="p">]):</span>
            <span class="n">dim1</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="k">for</span> <span class="n">ind</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">size</span><span class="p">[</span><span class="mi">1</span><span class="p">]):</span>
                <span class="n">dim2</span> <span class="o">=</span> <span class="p">[]</span>
                <span class="k">for</span> <span class="n">ind</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">size</span><span class="p">[</span><span class="mi">2</span><span class="p">]):</span>
                    <span class="n">dim2</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">type_object</span><span class="p">(</span><span class="s1">&#39; &#39;</span><span class="p">))</span>
                <span class="n">dim1</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">dim2</span><span class="p">)</span>
            <span class="n">dim0</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">dim1</span><span class="p">)</span>
    <span class="k">elif</span> <span class="n">N</span> <span class="o">==</span> <span class="mi">4</span><span class="p">:</span>
        <span class="k">for</span> <span class="n">ind</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">size</span><span class="p">[</span><span class="mi">0</span><span class="p">]):</span>
            <span class="n">dim1</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="k">for</span> <span class="n">ind</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">size</span><span class="p">[</span><span class="mi">1</span><span class="p">]):</span>
                <span class="n">dim2</span> <span class="o">=</span> <span class="p">[]</span>
                <span class="k">for</span> <span class="n">ind</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">size</span><span class="p">[</span><span class="mi">2</span><span class="p">]):</span>
                    <span class="n">dim3</span> <span class="o">=</span> <span class="p">[]</span>
                    <span class="k">for</span> <span class="n">ind</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">size</span><span class="p">[</span><span class="mi">3</span><span class="p">]):</span>
                        <span class="n">dim3</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">type_object</span><span class="p">(</span><span class="s1">&#39; &#39;</span><span class="p">))</span>
                    <span class="n">dim2</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">dim3</span><span class="p">)</span>
                <span class="n">dim1</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">dim2</span><span class="p">)</span>
            <span class="n">dim0</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">dim1</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">dim0</span></div>


<div class="viewcode-block" id="inv_pypol"><a class="viewcode-back" href="../../py_pol.html#py_pol.utils.inv_pypol">[docs]</a><span class="k">def</span> <span class="nf">inv_pypol</span><span class="p">(</span><span class="n">M</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Calculates the inverse matrix of the matrix of a py_pol object.</span>

<span class="sd">    Parameters:</span>
<span class="sd">        M (numpy.ndarray): Array to calculate the inverse. Its shape must be (NxNxM). The result will have the same shape.</span>

<span class="sd">    Returns:</span>
<span class="sd">        (numpy.ndarray): Result.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">M</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">moveaxis</span><span class="p">(</span><span class="n">M</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
    <span class="n">M</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">inv</span><span class="p">(</span><span class="n">M</span><span class="p">)</span>
    <span class="n">M</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">moveaxis</span><span class="p">(</span><span class="n">M</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">M</span></div>


<div class="viewcode-block" id="obj_error"><a class="viewcode-back" href="../../py_pol.html#py_pol.utils.obj_error">[docs]</a><span class="k">def</span> <span class="nf">obj_error</span><span class="p">(</span><span class="n">sol</span><span class="p">,</span> <span class="n">test</span><span class="p">,</span> <span class="n">shape</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">shape_like</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">out_number</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Calculates the difference between two abjects and calculates the error as the norm.&quot;&quot;&quot;</span>
    <span class="c1"># Check that both of them are of the same type</span>
    <span class="k">if</span> <span class="n">sol</span><span class="o">.</span><span class="n">_type</span> <span class="o">!=</span> <span class="n">test</span><span class="o">.</span><span class="n">_type</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
            <span class="s1">&#39;sol (</span><span class="si">{}</span><span class="s1">) and test (</span><span class="si">{}</span><span class="s1">) are of different types.&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                <span class="n">sol</span><span class="o">.</span><span class="n">_type</span><span class="p">,</span> <span class="n">test</span><span class="o">.</span><span class="n">_type</span><span class="p">))</span>
    <span class="c1"># Make them to have the same size</span>
    <span class="k">if</span> <span class="n">sol</span><span class="o">.</span><span class="n">size</span> <span class="o">&lt;</span> <span class="n">test</span><span class="o">.</span><span class="n">size</span><span class="p">:</span>
        <span class="n">obj1</span> <span class="o">=</span> <span class="n">sol</span><span class="o">.</span><span class="n">stretch</span><span class="p">(</span><span class="n">test</span><span class="o">.</span><span class="n">size</span><span class="p">,</span> <span class="n">keep</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="n">obj2</span> <span class="o">=</span> <span class="n">test</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
    <span class="k">elif</span> <span class="n">sol</span><span class="o">.</span><span class="n">size</span> <span class="o">&gt;</span> <span class="n">test</span><span class="o">.</span><span class="n">size</span><span class="p">:</span>
        <span class="n">obj1</span> <span class="o">=</span> <span class="n">sol</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
        <span class="n">obj2</span> <span class="o">=</span> <span class="n">test</span><span class="o">.</span><span class="n">stretch</span><span class="p">(</span><span class="n">sol</span><span class="o">.</span><span class="n">size</span><span class="p">,</span> <span class="n">keep</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">obj1</span> <span class="o">=</span> <span class="n">sol</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
        <span class="n">obj2</span> <span class="o">=</span> <span class="n">test</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
    <span class="c1"># Calculate the matrix difference</span>
    <span class="n">M</span> <span class="o">=</span> <span class="n">obj1</span><span class="o">.</span><span class="n">M</span> <span class="o">-</span> <span class="n">obj2</span><span class="o">.</span><span class="n">M</span>
    <span class="n">obj1</span><span class="o">.</span><span class="n">shape</span> <span class="o">=</span> <span class="n">take_shape</span><span class="p">((</span><span class="n">obj1</span><span class="p">,</span> <span class="n">obj2</span><span class="p">))</span>
    <span class="c1"># Calculate the norm</span>
    <span class="k">if</span> <span class="n">sol</span><span class="o">.</span><span class="n">_type</span> <span class="ow">in</span> <span class="p">(</span><span class="s1">&#39;Jones_vector&#39;</span><span class="p">,</span> <span class="s1">&#39;Stokes&#39;</span><span class="p">):</span>
        <span class="n">norm</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">norm</span><span class="p">(</span><span class="n">M</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">norm</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">norm</span><span class="p">(</span><span class="n">M</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">))</span>
    <span class="c1"># Reshape the norm</span>
    <span class="k">if</span> <span class="n">out_number</span> <span class="ow">and</span> <span class="n">norm</span><span class="o">.</span><span class="n">size</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
        <span class="n">norm</span> <span class="o">=</span> <span class="n">norm</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
    <span class="n">norm</span> <span class="o">=</span> <span class="n">reshape</span><span class="p">([</span><span class="n">norm</span><span class="p">],</span> <span class="n">shape_like</span><span class="o">=</span><span class="n">shape_like</span><span class="p">,</span> <span class="n">shape_fun</span><span class="o">=</span><span class="n">shape</span><span class="p">,</span> <span class="n">obj</span><span class="o">=</span><span class="n">obj1</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">norm</span></div>


<div class="viewcode-block" id="matmul_pypol"><a class="viewcode-back" href="../../py_pol.html#py_pol.utils.matmul_pypol">[docs]</a><span class="k">def</span> <span class="nf">matmul_pypol</span><span class="p">(</span><span class="n">M1</span><span class="p">,</span> <span class="n">M2</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Calculates the multiplication of two matrices from pypol objects.</span>

<span class="sd">    Parameters:</span>
<span class="sd">        M1, (numpy.ndarray): Left array to multiply. Its shape must be (NxNxM).</span>
<span class="sd">        M1, (numpy.ndarray): Right array to multiply. Its shape must be (NxNxM) or (NxM). The result will have the same shape.</span>

<span class="sd">    Returns:</span>
<span class="sd">        (numpy.ndarray): Result.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">M1</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">moveaxis</span><span class="p">(</span><span class="n">M1</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
    <span class="n">M2</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">moveaxis</span><span class="p">(</span><span class="n">M2</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">M2</span><span class="o">.</span><span class="n">ndim</span> <span class="o">==</span> <span class="mi">2</span><span class="p">:</span>
        <span class="n">M2</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">expand_dims</span><span class="p">(</span><span class="n">M2</span><span class="p">,</span> <span class="mi">2</span><span class="p">)</span>
    <span class="n">M</span> <span class="o">=</span> <span class="n">M1</span> <span class="o">@</span> <span class="n">M2</span>
    <span class="n">M</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">moveaxis</span><span class="p">(</span><span class="n">M</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">M</span></div>


<div class="viewcode-block" id="list_of_objects"><a class="viewcode-back" href="../../py_pol.html#py_pol.utils.list_of_objects">[docs]</a><span class="k">def</span> <span class="nf">list_of_objects</span><span class="p">(</span><span class="n">size</span><span class="p">,</span> <span class="n">type_object</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Creates a list of objects.&quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">size</span><span class="p">,</span> <span class="p">(</span><span class="nb">int</span><span class="p">,</span> <span class="nb">float</span><span class="p">)):</span>
        <span class="n">size</span> <span class="o">=</span> <span class="p">[</span><span class="n">size</span><span class="p">]</span>
    <span class="n">Ndims</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">size</span><span class="p">)</span>
    <span class="nb">list</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">ind</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">size</span><span class="p">[</span><span class="mi">0</span><span class="p">]):</span>
        <span class="k">if</span> <span class="n">Ndims</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
            <span class="nb">list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">list_of_objects</span><span class="p">(</span><span class="n">size</span><span class="p">[</span><span class="mi">1</span><span class="p">:</span><span class="n">Ndims</span> <span class="o">+</span> <span class="mi">1</span><span class="p">],</span> <span class="n">type_object</span><span class="p">))</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="nb">list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">type_object</span><span class="p">(</span><span class="s1">&#39; &#39;</span><span class="p">))</span>

    <span class="k">return</span> <span class="nb">list</span></div>


<span class="k">def</span> <span class="nf">_pickle_method</span><span class="p">(</span><span class="n">method</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    function for multiprocessing in class</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">func_name</span> <span class="o">=</span> <span class="n">method</span><span class="o">.</span><span class="vm">__func__</span><span class="o">.</span><span class="vm">__name__</span>
    <span class="n">obj</span> <span class="o">=</span> <span class="n">method</span><span class="o">.</span><span class="vm">__self__</span>
    <span class="bp">cls</span> <span class="o">=</span> <span class="n">method</span><span class="o">.</span><span class="vm">__self__</span><span class="o">.</span><span class="vm">__class__</span>
    <span class="c1"># deal with mangled names</span>
    <span class="k">if</span> <span class="n">func_name</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s1">&#39;__&#39;</span><span class="p">)</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">func_name</span><span class="o">.</span><span class="n">endswith</span><span class="p">(</span><span class="s1">&#39;__&#39;</span><span class="p">):</span>
        <span class="n">cls_name</span> <span class="o">=</span> <span class="bp">cls</span><span class="o">.</span><span class="vm">__name__</span><span class="o">.</span><span class="n">lstrip</span><span class="p">(</span><span class="s1">&#39;_&#39;</span><span class="p">)</span>
        <span class="n">func_name</span> <span class="o">=</span> <span class="s1">&#39;_&#39;</span> <span class="o">+</span> <span class="n">cls_name</span> <span class="o">+</span> <span class="n">func_name</span>
    <span class="k">return</span> <span class="n">_unpickle_method</span><span class="p">,</span> <span class="p">(</span><span class="n">func_name</span><span class="p">,</span> <span class="n">obj</span><span class="p">,</span> <span class="bp">cls</span><span class="p">)</span>


<span class="k">def</span> <span class="nf">_unpickle_method</span><span class="p">(</span><span class="n">func_name</span><span class="p">,</span> <span class="n">obj</span><span class="p">,</span> <span class="bp">cls</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    function for multiprocessing in class</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">for</span> <span class="bp">cls</span> <span class="ow">in</span> <span class="bp">cls</span><span class="o">.</span><span class="vm">__mro__</span><span class="p">:</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">func</span> <span class="o">=</span> <span class="bp">cls</span><span class="o">.</span><span class="vm">__dict__</span><span class="p">[</span><span class="n">func_name</span><span class="p">]</span>
        <span class="k">except</span> <span class="ne">KeyError</span><span class="p">:</span>
            <span class="k">pass</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">break</span>
    <span class="k">return</span> <span class="n">func</span><span class="o">.</span><span class="fm">__get__</span><span class="p">(</span><span class="n">obj</span><span class="p">,</span> <span class="bp">cls</span><span class="p">)</span>


<div class="viewcode-block" id="iscolumn"><a class="viewcode-back" href="../../py_pol.html#py_pol.utils.iscolumn">[docs]</a><span class="k">def</span> <span class="nf">iscolumn</span><span class="p">(</span><span class="n">v</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Checks if the array v is a column array or not.</span>

<span class="sd">    Parameters:</span>
<span class="sd">        v (array): Array to be tested.</span>

<span class="sd">    Returns:</span>
<span class="sd">        cond (bool): True if v is a column array.&quot;&quot;&quot;</span>

    <span class="n">cond</span> <span class="o">=</span> <span class="kc">False</span>
    <span class="n">s</span> <span class="o">=</span> <span class="n">v</span><span class="o">.</span><span class="n">shape</span>
    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">s</span><span class="p">)</span> <span class="o">==</span> <span class="mi">2</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">s</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">==</span> <span class="mi">1</span> <span class="ow">and</span> <span class="n">s</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
            <span class="n">cond</span> <span class="o">=</span> <span class="kc">True</span>
    <span class="k">return</span> <span class="n">cond</span></div>


<div class="viewcode-block" id="isrow"><a class="viewcode-back" href="../../py_pol.html#py_pol.utils.isrow">[docs]</a><span class="k">def</span> <span class="nf">isrow</span><span class="p">(</span><span class="n">v</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Checks if the array v is a row array or not.</span>

<span class="sd">    Parameters:</span>
<span class="sd">        v (array): Array to be tested.</span>

<span class="sd">    Returns:</span>
<span class="sd">        cond (bool): True if v is a row array.&quot;&quot;&quot;</span>

    <span class="n">cond</span> <span class="o">=</span> <span class="kc">False</span>
    <span class="n">s</span> <span class="o">=</span> <span class="n">v</span><span class="o">.</span><span class="n">shape</span>
    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">s</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
        <span class="n">cond</span> <span class="o">=</span> <span class="kc">True</span>
    <span class="k">elif</span> <span class="nb">len</span><span class="p">(</span><span class="n">s</span><span class="p">)</span> <span class="o">==</span> <span class="mi">2</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">s</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
            <span class="n">cond</span> <span class="o">=</span> <span class="kc">True</span>
    <span class="k">return</span> <span class="n">cond</span></div>


<div class="viewcode-block" id="delta_kron"><a class="viewcode-back" href="../../py_pol.html#py_pol.utils.delta_kron">[docs]</a><span class="k">def</span> <span class="nf">delta_kron</span><span class="p">(</span><span class="n">a</span><span class="p">,</span> <span class="n">b</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Computes the Kronecker delta.</span>

<span class="sd">    Parameters:</span>
<span class="sd">        a, b (int): Numbers.</span>

<span class="sd">    Returns:</span>
<span class="sd">        d (int): Result.&quot;&quot;&quot;</span>

    <span class="k">if</span> <span class="n">a</span> <span class="o">==</span> <span class="n">b</span><span class="p">:</span>
        <span class="n">d</span> <span class="o">=</span> <span class="mi">1</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">d</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="k">return</span> <span class="n">d</span></div>


<div class="viewcode-block" id="order_eig"><a class="viewcode-back" href="../../py_pol.html#py_pol.utils.order_eig">[docs]</a><span class="k">def</span> <span class="nf">order_eig</span><span class="p">(</span><span class="n">val</span><span class="p">,</span> <span class="n">vect</span><span class="p">,</span> <span class="n">kind</span><span class="o">=</span><span class="s1">&#39;normal&#39;</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Function that orders the eigenvalues from max to min, and then orders</span>
<span class="sd">    the eigenvectors following the same order.</span>

<span class="sd">    Parameters:</span>
<span class="sd">        val (numpy.ndarray): Array of eigenvalues.</span>
<span class="sd">        vect (numpy.ndarray): Matrix with the eigenvectors as columns.</span>
<span class="sd">        kind (string): Choses if the sort order is normal (min to max) or reverse (max to min).</span>

<span class="sd">    Returns:</span>
<span class="sd">        q (numpy.ndarray): Array of ordered eigenvalues.</span>
<span class="sd">        m (numpy.ndarray): Matrix with the eigenvectors ordered as columns.</span>
<span class="sd">        &quot;&quot;&quot;</span>
    <span class="c1"># Values must be real, so make them real</span>
    <span class="n">val</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">val</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">float</span><span class="p">)</span>
    <span class="n">vect</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">vect</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">float</span><span class="p">)</span>

    <span class="c1"># Reverse order if desired</span>
    <span class="k">if</span> <span class="n">kind</span><span class="o">.</span><span class="n">upper</span><span class="p">()</span> <span class="o">!=</span> <span class="s1">&#39;NORMAL&#39;</span><span class="p">:</span>
        <span class="n">val</span> <span class="o">=</span> <span class="o">-</span><span class="n">val</span>

    <span class="c1"># Make sure val is a 4xN array and vect a 4x4xN array</span>
    <span class="k">if</span> <span class="n">val</span><span class="o">.</span><span class="n">ndim</span> <span class="o">&gt;</span> <span class="mi">2</span><span class="p">:</span>
        <span class="c1"># Save the old shape</span>
        <span class="n">shape</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">val</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span>
        <span class="c1"># Reshape</span>
        <span class="n">size</span> <span class="o">=</span> <span class="n">val</span><span class="o">.</span><span class="n">size</span> <span class="o">/</span> <span class="mi">4</span>
        <span class="n">val</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="n">val</span><span class="p">,</span> <span class="p">[</span><span class="mi">4</span><span class="p">,</span> <span class="n">size</span><span class="p">])</span>
        <span class="n">vect</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="n">vect</span><span class="p">,</span> <span class="p">[</span><span class="mi">4</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="n">size</span><span class="p">])</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">shape</span> <span class="o">=</span> <span class="kc">None</span>

    <span class="c1"># Find the correct order</span>
    <span class="n">order</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">argsort</span><span class="p">(</span><span class="n">val</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
    <span class="c1"># Reorder</span>
    <span class="n">val</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sort</span><span class="p">(</span><span class="n">val</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">ind</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">4</span><span class="p">):</span>
        <span class="n">vect</span><span class="p">[</span><span class="n">ind</span><span class="p">,</span> <span class="p">:,</span> <span class="p">:]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">take_along_axis</span><span class="p">(</span><span class="n">vect</span><span class="p">[</span><span class="n">ind</span><span class="p">,</span> <span class="p">:,</span> <span class="p">:],</span> <span class="n">order</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
    <span class="c1"># # Find correct order</span>
    <span class="c1"># order = np.flip(np.argsort(q), 0)</span>
    <span class="c1"># # Order eigenvalues</span>
    <span class="c1"># q = np.flip(np.sort(q), 0)</span>
    <span class="c1"># # Order eigenvectors</span>
    <span class="c1"># s = m.shape</span>
    <span class="c1"># m2 = np.zeros(s, dtype=complex)</span>
    <span class="c1"># for ind in range(s[1]):</span>
    <span class="c1">#     ind2 = order[ind]</span>
    <span class="c1">#     m2[:, ind] = np.squeeze(m[:, ind2])</span>
    <span class="c1"># # Differentiate between real and complex cases</span>
    <span class="c1"># Im = np.linalg.norm(np.imag(q))</span>
    <span class="c1"># if Im &lt; tol_default:</span>
    <span class="c1">#     q = np.real(q)</span>
    <span class="c1"># Im = np.linalg.norm(np.imag(m2))</span>
    <span class="c1"># if Im &lt; tol_default:</span>
    <span class="c1">#     m2 = np.real(m2)</span>
    <span class="c1"># # Return</span>
    <span class="c1"># return q, np.matrix(m2, dtype=complex)</span>

    <span class="c1"># Reshape again if necessary</span>
    <span class="k">if</span> <span class="n">shape</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">val</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="n">val</span><span class="p">,</span> <span class="n">shape</span><span class="p">)</span>
        <span class="n">vect</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="n">vect</span><span class="p">,</span> <span class="p">[</span><span class="mi">4</span><span class="p">]</span> <span class="o">+</span> <span class="n">shape</span><span class="p">)</span>

    <span class="c1"># Reverse order if desired</span>
    <span class="k">if</span> <span class="n">kind</span><span class="o">.</span><span class="n">upper</span><span class="p">()</span> <span class="o">!=</span> <span class="s1">&#39;NORMAL&#39;</span><span class="p">:</span>
        <span class="n">val</span> <span class="o">=</span> <span class="o">-</span><span class="n">val</span>

    <span class="k">return</span> <span class="n">val</span><span class="p">,</span> <span class="n">vect</span></div>


<div class="viewcode-block" id="check_eig"><a class="viewcode-back" href="../../py_pol.html#py_pol.utils.check_eig">[docs]</a><span class="k">def</span> <span class="nf">check_eig</span><span class="p">(</span><span class="n">q</span><span class="p">,</span> <span class="n">m</span><span class="p">,</span> <span class="n">M</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Function that checks the eigenvalues and eigenvectors.&quot;&quot;&quot;</span>
    <span class="n">dif</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">q</span><span class="p">))</span>
    <span class="k">for</span> <span class="n">ind</span><span class="p">,</span> <span class="n">qi</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">q</span><span class="p">):</span>
        <span class="n">v</span> <span class="o">=</span> <span class="n">m</span><span class="p">[:,</span> <span class="n">ind</span><span class="p">]</span>
        <span class="n">v2</span> <span class="o">=</span> <span class="n">M</span> <span class="o">*</span> <span class="n">v</span>
        <span class="n">d</span> <span class="o">=</span> <span class="n">v2</span> <span class="o">-</span> <span class="n">qi</span> <span class="o">*</span> <span class="n">v</span>
        <span class="n">dif</span><span class="p">[</span><span class="n">ind</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">norm</span><span class="p">(</span><span class="n">d</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">((</span><span class="s2">&quot;The eigenvalue </span><span class="si">{}</span><span class="s2"> has an eigenvector </span><span class="si">{}</span><span class="s2">.&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">qi</span><span class="p">,</span> <span class="n">v</span><span class="o">.</span><span class="n">T</span><span class="p">)))</span>
    <span class="n">M2</span> <span class="o">=</span> <span class="n">m</span> <span class="o">*</span> <span class="n">M</span> <span class="o">*</span> <span class="n">m</span><span class="o">.</span><span class="n">T</span>
    <span class="n">d</span> <span class="o">=</span> <span class="n">M2</span> <span class="o">-</span> <span class="n">M</span>
    <span class="n">dif2</span> <span class="o">=</span> <span class="n">sqrt</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">square</span><span class="p">(</span><span class="n">d</span><span class="p">)))</span>
    <span class="n">dif3</span> <span class="o">=</span> <span class="p">(</span><span class="nb">abs</span><span class="p">(</span><span class="n">d</span><span class="p">))</span><span class="o">.</span><span class="n">max</span><span class="p">()</span>
    <span class="n">d</span> <span class="o">=</span> <span class="n">m</span><span class="o">.</span><span class="n">T</span> <span class="o">-</span> <span class="n">m</span><span class="o">.</span><span class="n">I</span>
    <span class="n">dif4</span> <span class="o">=</span> <span class="n">sqrt</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">square</span><span class="p">(</span><span class="n">d</span><span class="p">)))</span>
    <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;The eigenvalues are:&#39;</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="n">q</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;The deviation respect to the eigenvectors is:&#39;</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="n">dif</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span>
        <span class="p">(</span><span class="s1">&#39;The mean square difference in the decomposition is: </span><span class="si">{}</span><span class="s1">.&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">dif2</span><span class="p">)</span>
         <span class="p">))</span>
    <span class="nb">print</span><span class="p">((</span><span class="s1">&#39;The maximum difference in the decomposition is: </span><span class="si">{}</span><span class="s1">.&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">dif3</span><span class="p">)))</span>
    <span class="nb">print</span><span class="p">((</span><span class="s1">&#39;The matrix of eigenvalues is orthogonal with deviation </span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
        <span class="n">dif4</span><span class="p">)))</span>
    <span class="nb">print</span><span class="p">(</span><span class="n">M</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="n">M2</span><span class="p">)</span></div>


<span class="c1"># def seq(start, stop, step=1):</span>
<span class="c1">#     n = int(round((stop - start) / float(step)))</span>
<span class="c1">#     if n &gt; 1:</span>
<span class="c1">#         return ([start + step * i for i in range(n + 1)])</span>
<span class="c1">#     else:</span>
<span class="c1">#         return ([])</span>


<div class="viewcode-block" id="distance"><a class="viewcode-back" href="../../py_pol.html#py_pol.utils.distance">[docs]</a><span class="k">def</span> <span class="nf">distance</span><span class="p">(</span><span class="n">x1</span><span class="p">,</span> <span class="n">x2</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Compute distance between two vectors.</span>

<span class="sd">    Arguments:</span>
<span class="sd">        x1 (numpy.ndarray): vector 1</span>
<span class="sd">        x2 (numpy.ndarray): vector 2</span>

<span class="sd">    Returns:</span>
<span class="sd">        (float): distance between vectors.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">x1</span> <span class="o">=</span> <span class="n">array</span><span class="p">(</span><span class="n">x1</span><span class="p">)</span>
    <span class="n">x2</span> <span class="o">=</span> <span class="n">array</span><span class="p">(</span><span class="n">x2</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="n">x1</span><span class="o">.</span><span class="n">ndim</span><span class="p">)</span>

    <span class="n">dist2</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">x1</span><span class="o">.</span><span class="n">ndim</span><span class="p">):</span>
        <span class="n">dist2</span> <span class="o">=</span> <span class="n">dist2</span> <span class="o">+</span> <span class="p">(</span><span class="n">x1</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">-</span> <span class="n">x2</span><span class="p">[</span><span class="n">i</span><span class="p">])</span><span class="o">**</span><span class="mi">2</span>

    <span class="k">return</span> <span class="n">sp</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">dist2</span><span class="p">)</span></div>


<div class="viewcode-block" id="nearest"><a class="viewcode-back" href="../../py_pol.html#py_pol.utils.nearest">[docs]</a><span class="k">def</span> <span class="nf">nearest</span><span class="p">(</span><span class="n">vector</span><span class="p">,</span> <span class="n">number</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Computes the nearest element in vector to number.</span>

<span class="sd">        Parameters:</span>
<span class="sd">            vector (numpy.ndarray): array with numbers</span>
<span class="sd">            number (float):  number to determine position</span>

<span class="sd">        Returns:</span>
<span class="sd">            (int): index - index of vector which is closest to number.</span>
<span class="sd">            (float): value  - value of vector[index].</span>
<span class="sd">            (float): distance - difference between number and chosen element.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">indexes</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">vector</span> <span class="o">-</span> <span class="n">number</span><span class="p">)</span><span class="o">.</span><span class="n">argmin</span><span class="p">()</span>
    <span class="n">values</span> <span class="o">=</span> <span class="n">vector</span><span class="o">.</span><span class="n">flat</span><span class="p">[</span><span class="n">indexes</span><span class="p">]</span>
    <span class="n">distances</span> <span class="o">=</span> <span class="n">values</span> <span class="o">-</span> <span class="n">number</span>
    <span class="k">return</span> <span class="n">indexes</span><span class="p">,</span> <span class="n">values</span><span class="p">,</span> <span class="n">distances</span></div>


<div class="viewcode-block" id="nearest2"><a class="viewcode-back" href="../../py_pol.html#py_pol.utils.nearest2">[docs]</a><span class="k">def</span> <span class="nf">nearest2</span><span class="p">(</span><span class="n">vector</span><span class="p">,</span> <span class="n">numbers</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Computes the nearest element in vector to numbers.</span>

<span class="sd">        Parameters:</span>
<span class="sd">            vector (numpy.ndarray): array with numbers</span>
<span class="sd">            number (numpy.ndarray):  numbers to determine position</span>

<span class="sd">        Returns:</span>
<span class="sd">            (numpy.ndarray): index - indexes of vector which is closest to number.</span>
<span class="sd">            (numpy.ndarray): value  - values of vector[indexes].</span>
<span class="sd">            (numpy.ndarray): distance - difference between numbers and chosen elements.</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">indexes</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">subtract</span><span class="o">.</span><span class="n">outer</span><span class="p">(</span><span class="n">vector</span><span class="p">,</span> <span class="n">numbers</span><span class="p">))</span><span class="o">.</span><span class="n">argmin</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
    <span class="n">values</span> <span class="o">=</span> <span class="n">vector</span><span class="p">[</span><span class="n">indexes</span><span class="p">]</span>
    <span class="n">distances</span> <span class="o">=</span> <span class="n">values</span> <span class="o">-</span> <span class="n">numbers</span>
    <span class="k">return</span> <span class="n">indexes</span><span class="p">,</span> <span class="n">values</span><span class="p">,</span> <span class="n">distances</span></div>


<div class="viewcode-block" id="repair_name"><a class="viewcode-back" href="../../py_pol.html#py_pol.utils.repair_name">[docs]</a><span class="k">def</span> <span class="nf">repair_name</span><span class="p">(</span><span class="n">name_initial</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Repairs name when several angles are included.</span>

<span class="sd">    Example:</span>
<span class="sd">        M1 @45.00deg @45.00deg @45.00deg @45.00deg @45.00deg @45.00deg @45.00deg</span>

<span class="sd">        passes to:</span>

<span class="sd">        M1 @135.00deg</span>

<span class="sd">    Parameters:</span>
<span class="sd">        name_initial (str): String with the name.</span>

<span class="sd">    Returns:</span>
<span class="sd">        (str): Repaired name</span>

<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">num_angles</span> <span class="o">=</span> <span class="n">name_initial</span><span class="o">.</span><span class="n">count</span><span class="p">(</span><span class="s1">&#39;@&#39;</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">num_angles</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">name_initial</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">text</span> <span class="o">=</span> <span class="s2">&quot;</span><span class="si">{}</span><span class="s2"> &quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">name_initial</span><span class="p">)</span>

        <span class="n">text</span> <span class="o">=</span> <span class="n">text</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;@&quot;</span><span class="p">)</span>
        <span class="n">name_original</span> <span class="o">=</span> <span class="n">text</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">0</span><span class="p">:</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
        <span class="n">angle_number</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">ti</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">text</span><span class="p">[</span><span class="mi">1</span><span class="p">:]):</span>
            <span class="n">ri</span> <span class="o">=</span> <span class="n">ti</span><span class="o">.</span><span class="n">rfind</span><span class="p">(</span><span class="s1">&#39;d&#39;</span><span class="p">)</span>
            <span class="n">angle</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">ti</span><span class="p">[:</span><span class="n">ri</span><span class="p">])</span>
            <span class="n">angle_number</span> <span class="o">=</span> <span class="n">angle_number</span> <span class="o">+</span> <span class="n">angle</span>
        <span class="n">angle_number</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">remainder</span><span class="p">(</span><span class="n">angle_number</span><span class="p">,</span> <span class="mi">360</span><span class="p">)</span>
        <span class="n">name_final</span> <span class="o">=</span> <span class="s2">&quot;</span><span class="si">{}</span><span class="s2"> @ </span><span class="si">{:2.2f}</span><span class="s2"> deg&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">name_original</span><span class="p">,</span> <span class="n">angle_number</span><span class="p">)</span>
    <span class="k">except</span><span class="p">:</span>
        <span class="n">name_final</span> <span class="o">=</span> <span class="n">name_initial</span>
    <span class="k">return</span> <span class="n">name_final</span></div>


<div class="viewcode-block" id="comparison"><a class="viewcode-back" href="../../py_pol.html#py_pol.utils.comparison">[docs]</a><span class="k">def</span> <span class="nf">comparison</span><span class="p">(</span><span class="n">proposal</span><span class="p">,</span> <span class="n">solution</span><span class="p">,</span> <span class="n">maximum_diff</span><span class="o">=</span><span class="n">tol_default</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;This functions is mainly for testing. It compares compares proposal to solution.</span>

<span class="sd">    Parameters:</span>
<span class="sd">        proposal (numpy.matrix): proposal of result.</span>
<span class="sd">        solution (numpy.matrix): results of the test.</span>
<span class="sd">        maximum_diff (float): maximum difference allowed.</span>

<span class="sd">    Returns:</span>
<span class="sd">        (bool): True if comparison is possitive, else False.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1"># Just in case</span>
    <span class="n">proposal</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">proposal</span><span class="p">)</span>
    <span class="n">solution</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">solution</span><span class="p">)</span>

    <span class="n">comparison1</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">norm</span><span class="p">(</span><span class="n">proposal</span> <span class="o">-</span> <span class="n">solution</span><span class="p">)</span> <span class="o">&lt;</span> <span class="n">maximum_diff</span>
    <span class="n">comparison2</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">norm</span><span class="p">(</span><span class="n">proposal</span> <span class="o">+</span> <span class="n">solution</span><span class="p">)</span> <span class="o">&lt;</span> <span class="n">maximum_diff</span>

    <span class="k">return</span> <span class="n">comparison1</span> <span class="ow">or</span> <span class="n">comparison2</span></div>


<div class="viewcode-block" id="params_to_list"><a class="viewcode-back" href="../../py_pol.html#py_pol.utils.params_to_list">[docs]</a><span class="k">def</span> <span class="nf">params_to_list</span><span class="p">(</span><span class="n">J</span><span class="p">,</span> <span class="n">verbose</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Makes a list from data provided at parameters.dict_params</span>

<span class="sd">        Parameters:</span>
<span class="sd">            J (object): Object Jones_vector, Jones_matrix, Stokes or Mueller.</span>
<span class="sd">            verbose (bool): If True prints the parameters</span>

<span class="sd">        Returns:</span>
<span class="sd">            (list): List with parameters from dict_params.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">if</span> <span class="n">J</span><span class="o">.</span><span class="n">_type</span> <span class="o">==</span> <span class="s1">&#39;Jones_vector&#39;</span><span class="p">:</span>
        <span class="n">params</span> <span class="o">=</span> <span class="n">J</span><span class="o">.</span><span class="n">parameters</span><span class="o">.</span><span class="n">dict_params</span>

        <span class="n">intensity</span> <span class="o">=</span> <span class="n">params</span><span class="p">[</span><span class="s1">&#39;intensity&#39;</span><span class="p">]</span>
        <span class="n">alpha</span> <span class="o">=</span> <span class="n">params</span><span class="p">[</span><span class="s1">&#39;alpha&#39;</span><span class="p">]</span>
        <span class="n">delay</span> <span class="o">=</span> <span class="n">params</span><span class="p">[</span><span class="s1">&#39;delay&#39;</span><span class="p">]</span>
        <span class="n">azimuth</span> <span class="o">=</span> <span class="n">params</span><span class="p">[</span><span class="s1">&#39;azimuth&#39;</span><span class="p">]</span>
        <span class="n">ellipticity_angle</span> <span class="o">=</span> <span class="n">params</span><span class="p">[</span><span class="s1">&#39;ellipticity_angle&#39;</span><span class="p">]</span>
        <span class="n">a</span><span class="p">,</span> <span class="n">b</span> <span class="o">=</span> <span class="n">params</span><span class="p">[</span><span class="s1">&#39;ellipse_axes&#39;</span><span class="p">][</span><span class="mi">0</span><span class="p">],</span> <span class="n">params</span><span class="p">[</span><span class="s1">&#39;ellipse_axes&#39;</span><span class="p">][</span><span class="mi">1</span><span class="p">]</span>

        <span class="k">if</span> <span class="n">verbose</span> <span class="ow">is</span> <span class="kc">True</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;(</span><span class="si">{}</span><span class="s2">, </span><span class="si">{}</span><span class="s2">, </span><span class="si">{}</span><span class="s2">, </span><span class="si">{}</span><span class="s2">, </span><span class="si">{}</span><span class="s2">, </span><span class="si">{}</span><span class="s2">, </span><span class="si">{}</span><span class="s2">)&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                <span class="n">intensity</span><span class="p">,</span> <span class="n">alpha</span><span class="p">,</span> <span class="n">delay</span><span class="p">,</span> <span class="n">azimuth</span><span class="p">,</span> <span class="n">ellipticity_angle</span><span class="p">,</span> <span class="n">a</span><span class="p">,</span> <span class="n">b</span><span class="p">))</span>

        <span class="k">return</span> <span class="n">intensity</span><span class="p">,</span> <span class="n">alpha</span><span class="p">,</span> <span class="n">delay</span><span class="p">,</span> <span class="n">azimuth</span><span class="p">,</span> <span class="n">ellipticity_angle</span><span class="p">,</span> <span class="n">a</span><span class="p">,</span> <span class="n">b</span>

    <span class="k">elif</span> <span class="n">J</span><span class="o">.</span><span class="n">_type</span> <span class="o">==</span> <span class="s1">&#39;Stokes&#39;</span><span class="p">:</span>
        <span class="n">params</span> <span class="o">=</span> <span class="n">J</span><span class="o">.</span><span class="n">parameters</span><span class="o">.</span><span class="n">dict_params</span>

        <span class="n">intensity</span> <span class="o">=</span> <span class="n">params</span><span class="p">[</span><span class="s1">&#39;intensity&#39;</span><span class="p">]</span>
        <span class="n">amplitudes</span> <span class="o">=</span> <span class="n">params</span><span class="p">[</span><span class="s1">&#39;amplitudes&#39;</span><span class="p">]</span>
        <span class="n">degree_pol</span> <span class="o">=</span> <span class="n">params</span><span class="p">[</span><span class="s1">&#39;degree_pol&#39;</span><span class="p">]</span>
        <span class="n">degree_linear_pol</span> <span class="o">=</span> <span class="n">params</span><span class="p">[</span><span class="s1">&#39;degree_linear_pol&#39;</span><span class="p">]</span>
        <span class="n">degree_circular_pol</span> <span class="o">=</span> <span class="n">params</span><span class="p">[</span><span class="s1">&#39;degree_circular_pol&#39;</span><span class="p">]</span>
        <span class="n">alpha</span> <span class="o">=</span> <span class="n">params</span><span class="p">[</span><span class="s1">&#39;alpha&#39;</span><span class="p">]</span>
        <span class="n">delay</span> <span class="o">=</span> <span class="n">params</span><span class="p">[</span><span class="s1">&#39;delay&#39;</span><span class="p">]</span>
        <span class="n">azimuth</span> <span class="o">=</span> <span class="n">params</span><span class="p">[</span><span class="s1">&#39;azimuth&#39;</span><span class="p">]</span>
        <span class="n">ellipticity_angle</span> <span class="o">=</span> <span class="n">params</span><span class="p">[</span><span class="s1">&#39;ellipticity_angle&#39;</span><span class="p">]</span>
        <span class="n">ellipticity_param</span> <span class="o">=</span> <span class="n">params</span><span class="p">[</span><span class="s1">&#39;ellipticity_param&#39;</span><span class="p">]</span>
        <span class="n">polarized</span> <span class="o">=</span> <span class="n">params</span><span class="p">[</span><span class="s1">&#39;polarized&#39;</span><span class="p">]</span>
        <span class="n">unpolarized</span> <span class="o">=</span> <span class="n">params</span><span class="p">[</span><span class="s1">&#39;unpolarized&#39;</span><span class="p">]</span>

        <span class="k">if</span> <span class="n">verbose</span> <span class="ow">is</span> <span class="kc">True</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;(</span><span class="si">{}</span><span class="s2">, </span><span class="si">{}</span><span class="s2">, </span><span class="si">{}</span><span class="s2">, </span><span class="si">{}</span><span class="s2">, </span><span class="si">{}</span><span class="s2">, </span><span class="si">{}</span><span class="s2">, </span><span class="si">{}</span><span class="s2">, </span><span class="si">{}</span><span class="s2">, </span><span class="si">{}</span><span class="s2">, </span><span class="si">{}</span><span class="s2">, </span><span class="si">{}</span><span class="s2">, </span><span class="si">{}</span><span class="s2">)&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                <span class="n">intensity</span><span class="p">,</span> <span class="n">amplitudes</span><span class="p">,</span> <span class="n">degree_pol</span><span class="p">,</span> <span class="n">degree_linear_pol</span><span class="p">,</span>
                <span class="n">degree_circular_pol</span><span class="p">,</span> <span class="n">alpha</span><span class="p">,</span> <span class="n">delay</span><span class="p">,</span> <span class="n">azimuth</span><span class="p">,</span> <span class="n">ellipticity_angle</span><span class="p">,</span>
                <span class="n">ellipticity_param</span><span class="p">,</span> <span class="n">polarized</span><span class="p">,</span> <span class="n">unpolarized</span><span class="p">))</span>

        <span class="k">return</span> <span class="n">intensity</span><span class="p">,</span> <span class="n">amplitudes</span><span class="p">,</span> <span class="n">degree_pol</span><span class="p">,</span> <span class="n">degree_linear_pol</span><span class="p">,</span> <span class="n">degree_circular_pol</span><span class="p">,</span> <span class="n">alpha</span><span class="p">,</span> <span class="n">delay</span><span class="p">,</span> <span class="n">azimuth</span><span class="p">,</span> <span class="n">ellipticity_angle</span><span class="p">,</span> <span class="n">ellipticity_param</span><span class="p">,</span> <span class="n">polarized</span><span class="p">,</span> <span class="n">unpolarized</span>

    <span class="k">elif</span> <span class="n">J</span><span class="o">.</span><span class="n">_type</span> <span class="o">==</span> <span class="s1">&#39;Jones_matrix&#39;</span><span class="p">:</span>
        <span class="n">params</span> <span class="o">=</span> <span class="n">J</span><span class="o">.</span><span class="n">parameters</span><span class="o">.</span><span class="n">dict_params</span>

        <span class="n">delay</span> <span class="o">=</span> <span class="n">params</span><span class="p">[</span><span class="s1">&#39;delay&#39;</span><span class="p">]</span>
        <span class="n">diattenuation</span> <span class="o">=</span> <span class="n">params</span><span class="p">[</span><span class="s1">&#39;diattenuation&#39;</span><span class="p">]</span>
        <span class="n">is_homogeneous</span> <span class="o">=</span> <span class="n">params</span><span class="p">[</span><span class="s1">&#39;is_homogeneous&#39;</span><span class="p">]</span>

        <span class="k">if</span> <span class="n">verbose</span> <span class="ow">is</span> <span class="kc">True</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;(</span><span class="si">{}</span><span class="s2">, </span><span class="si">{}</span><span class="s2">, </span><span class="si">{}</span><span class="s2">)&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">delay</span><span class="p">,</span> <span class="n">diattenuation</span><span class="p">,</span> <span class="n">is_homogeneous</span><span class="p">))</span>

        <span class="k">return</span> <span class="n">delay</span><span class="p">,</span> <span class="n">diattenuation</span><span class="p">,</span> <span class="n">is_homogeneous</span>

    <span class="k">elif</span> <span class="n">J</span><span class="o">.</span><span class="n">_type</span> <span class="o">==</span> <span class="s1">&#39;Mueller&#39;</span><span class="p">:</span>
        <span class="k">pass</span></div>


<span class="c1"># def fit_phase(param, phase, irrelevant=0):</span>
<span class="c1">#     s = phase.shape</span>
<span class="c1">#     Th0, X = np.meshgrid(param[:s[1]], np.arange(s[0]))</span>
<span class="c1">#     W, _ = np.meshgrid(param[s[1]:2 * s[1]], np.arange(s[0]))</span>
<span class="c1">#     # print(&#39;phase shape = {}\nX shape = {}\n&#39;.format(s, X.shape))</span>
<span class="c1">#     test = (Th0 + X * W) % (2 * np.pi)</span>
<span class="c1">#     # print(&#39;phase&#39;, phase % (2 * np.pi))</span>
<span class="c1">#     # print(&#39;test&#39;, test)</span>
<span class="c1">#     error = (test - phase % (2 * np.pi)).flatten()</span>
<span class="c1">#     print(&#39;error&#39;, error, np.linalg.norm(error))</span>
<span class="c1">#     return error</span>


<div class="viewcode-block" id="fit_distribution"><a class="viewcode-back" href="../../py_pol.html#py_pol.utils.fit_distribution">[docs]</a><span class="k">def</span> <span class="nf">fit_distribution</span><span class="p">(</span><span class="n">param</span><span class="p">,</span> <span class="n">dist</span><span class="p">,</span> <span class="n">irrelevant</span><span class="o">=</span><span class="mi">0</span><span class="p">):</span>
    <span class="n">s</span> <span class="o">=</span> <span class="n">dist</span><span class="o">.</span><span class="n">shape</span>
    <span class="n">Th0</span><span class="p">,</span> <span class="n">X</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">meshgrid</span><span class="p">(</span><span class="n">param</span><span class="p">[:</span><span class="n">s</span><span class="p">[</span><span class="mi">1</span><span class="p">]],</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="n">s</span><span class="p">[</span><span class="mi">0</span><span class="p">]))</span>
    <span class="n">W</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">meshgrid</span><span class="p">(</span><span class="n">param</span><span class="p">[</span><span class="n">s</span><span class="p">[</span><span class="mi">1</span><span class="p">]:</span><span class="mi">2</span> <span class="o">*</span> <span class="n">s</span><span class="p">[</span><span class="mi">1</span><span class="p">]],</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="n">s</span><span class="p">[</span><span class="mi">0</span><span class="p">]))</span>
    <span class="n">A</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">meshgrid</span><span class="p">(</span><span class="n">param</span><span class="p">[</span><span class="mi">2</span> <span class="o">*</span> <span class="n">s</span><span class="p">[</span><span class="mi">1</span><span class="p">]:],</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="n">s</span><span class="p">[</span><span class="mi">0</span><span class="p">]))</span>
    <span class="n">test</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">cos</span><span class="p">(</span><span class="n">Th0</span> <span class="o">+</span> <span class="n">X</span> <span class="o">*</span> <span class="n">W</span><span class="p">)</span> <span class="o">*</span> <span class="n">A</span>
    <span class="n">error</span> <span class="o">=</span> <span class="p">(</span><span class="n">test</span> <span class="o">-</span> <span class="n">dist</span><span class="p">)</span><span class="o">.</span><span class="n">flatten</span><span class="p">()</span>
    <span class="c1"># print(np.linalg.norm(error))</span>
    <span class="k">return</span> <span class="n">error</span></div>


<div class="viewcode-block" id="fit_cos"><a class="viewcode-back" href="../../py_pol.html#py_pol.utils.fit_cos">[docs]</a><span class="k">def</span> <span class="nf">fit_cos</span><span class="p">(</span><span class="n">par</span><span class="p">,</span> <span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Function to fit a cos function using the least_squares function from scipy.optimize.&quot;&quot;&quot;</span>
    <span class="n">c</span> <span class="o">=</span> <span class="n">par</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">cos</span><span class="p">(</span><span class="n">par</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">+</span> <span class="n">x</span> <span class="o">*</span> <span class="n">par</span><span class="p">[</span><span class="mi">2</span><span class="p">])</span>
    <span class="k">return</span> <span class="n">y</span> <span class="o">-</span> <span class="n">c</span></div>


<div class="viewcode-block" id="fit_sine"><a class="viewcode-back" href="../../py_pol.html#py_pol.utils.fit_sine">[docs]</a><span class="k">def</span> <span class="nf">fit_sine</span><span class="p">(</span><span class="n">t</span><span class="p">,</span> <span class="n">data</span><span class="p">,</span> <span class="n">has_draw</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;fit a sine function</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">def</span> <span class="nf">optimize_func</span><span class="p">(</span><span class="n">x</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">x</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">sin</span><span class="p">(</span><span class="n">x</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">*</span> <span class="n">t</span> <span class="o">+</span> <span class="n">x</span><span class="p">[</span><span class="mi">2</span><span class="p">])</span> <span class="o">+</span> <span class="n">x</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">-</span> <span class="n">data</span>

    <span class="n">guess_mean</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>
    <span class="n">guess_std</span> <span class="o">=</span> <span class="mi">3</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">std</span><span class="p">(</span><span class="n">data</span><span class="p">)</span> <span class="o">/</span> <span class="p">(</span><span class="mi">2</span><span class="o">**</span><span class="mf">0.5</span><span class="p">)</span> <span class="o">/</span> <span class="p">(</span><span class="mi">2</span><span class="o">**</span><span class="mf">0.5</span><span class="p">)</span>
    <span class="n">guess_phase</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="n">guess_freq</span> <span class="o">=</span> <span class="mi">1</span>
    <span class="n">guess_amp</span> <span class="o">=</span> <span class="mi">1</span>

    <span class="c1"># This might already be good enough for you</span>
    <span class="n">data_first_guess</span> <span class="o">=</span> <span class="n">guess_std</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">sin</span><span class="p">(</span><span class="n">t</span> <span class="o">+</span> <span class="n">guess_phase</span><span class="p">)</span> <span class="o">+</span> <span class="n">guess_mean</span>

    <span class="c1"># Define the function to optimize, in this case, we want to minimize</span>
    <span class="c1"># the difference between the actual data and our &quot;guessed&quot; parameters</span>

    <span class="n">est_amp</span><span class="p">,</span> <span class="n">est_freq</span><span class="p">,</span> <span class="n">est_phase</span><span class="p">,</span> <span class="n">est_mean</span> <span class="o">=</span> <span class="n">leastsq</span><span class="p">(</span>
        <span class="n">optimize_func</span><span class="p">,</span> <span class="p">[</span><span class="n">guess_amp</span><span class="p">,</span> <span class="n">guess_freq</span><span class="p">,</span> <span class="n">guess_phase</span><span class="p">,</span> <span class="n">guess_mean</span><span class="p">])[</span><span class="mi">0</span><span class="p">]</span>

    <span class="c1"># recreate the fitted curve using the optimized parameters</span>

    <span class="k">if</span> <span class="n">has_draw</span> <span class="ow">is</span> <span class="kc">True</span><span class="p">:</span>
        <span class="n">fine_t</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="nb">max</span><span class="p">(</span><span class="n">t</span><span class="p">),</span> <span class="mf">0.1</span><span class="p">)</span>
        <span class="n">data_fit</span> <span class="o">=</span> <span class="n">est_amp</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">sin</span><span class="p">(</span><span class="n">est_freq</span> <span class="o">*</span> <span class="n">fine_t</span> <span class="o">+</span> <span class="n">est_phase</span><span class="p">)</span> <span class="o">+</span> <span class="n">est_mean</span>

        <span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">()</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">t</span><span class="p">,</span> <span class="n">data</span><span class="p">,</span> <span class="s1">&#39;.&#39;</span><span class="p">)</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">t</span><span class="p">,</span> <span class="n">data_first_guess</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s1">&#39;first guess&#39;</span><span class="p">)</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">fine_t</span><span class="p">,</span> <span class="n">data_fit</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s1">&#39;after fitting&#39;</span><span class="p">)</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">legend</span><span class="p">()</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>

    <span class="k">return</span> <span class="n">est_amp</span><span class="p">,</span> <span class="n">est_freq</span><span class="p">,</span> <span class="n">est_phase</span><span class="p">,</span> <span class="n">est_mean</span></div>


<span class="c1"># recreate the fitted curve using the optimized parameters</span>
</pre></div>

           </div>
           
          </div>
          <footer>
  

  <hr/>

  <div role="contentinfo">
    <p>
        
        &copy; Copyright 2019, Luis Miguel Sanchez Brea / Jesus del Hoyo

    </p>
  </div>
    
    
    
    Built with <a href="http://sphinx-doc.org/">Sphinx</a> using a
    
    <a href="https://github.com/rtfd/sphinx_rtd_theme">theme</a>
    
    provided by <a href="https://readthedocs.org">Read the Docs</a>. 

</footer>

        </div>
      </div>

    </section>

  </div>
  

  <script type="text/javascript">
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script>

  
  
    
   

</body>
</html>